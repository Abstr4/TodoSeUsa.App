@page "/consignadores"

@using TodoSeUsa.Application.Features.Consignments.Interfaces
@using TodoSeUsa.Application.Features.Consignors.DTOs
@using TodoSeUsa.Application.Features.Consignors.Interfaces
@using TodoSeUsa.BlazorServer.Features.Shared

@rendermode InteractiveServer

@inject IConsignorService ConsignorService;
@inject IConsignmentService ConsignmentService;

@inject DialogService DialogService;
@inject NavigationManager NavigationManager;
@inject SimpleNotifications SimpleNotifications;

@attribute [Authorize]

<style>
    .rz-custom-header {
        width: 100%;
    }
</style>

<RadzenCard Style="max-width: 100%">

    <PageTitleWithBackButton Title="Consignadores" />

    <RadzenDataGrid @ref="grid" 
        TItem="ConsignorDto" 
        Data="@consignors" 
        LoadData="@LoadConsignors" 
        IsLoading="@isLoading" 
        @bind-Value="@selectedConsignors" 
        Count="@count" 
        EmptyText="@GridMessage" 
        LogicalFilterOperator="@logicalFilterOperator" 
        SelectionMode="DataGridSelectionMode.Single" 
        PageSize="5" 
        AllowSorting="true" 
        AllowFiltering="true" 
        AllowPaging="true" 
        AllowColumnResize=true 
        FilterMode="FilterMode.Simple" 
        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" 
        PagerHorizontalAlign="HorizontalAlign.Center" 
        ClearFilterText="Limpiar" ApplyFilterText="Aplicar" FilterText="Filtro" 
        ContainsText="Contiene" EqualsText="Equivale" AndOperatorText="Y" 
        OrOperatorText="O" LessThanOrEqualsText="Menor o igual que" LessThanText="Menor que" 
        GreaterThanOrEqualsText="Mayor o igual que" GreaterThanText="Mayor que" NotEqualsText="No es igual a" 
        IsNullText="Es nulo" IsNotNullText="No es nulo" ColumnWidth="200px">

        <HeaderTemplate>

            <RadzenStack Wrap="FlexWrap.Wrap" JustifyContent="JustifyContent.SpaceBetween" Orientation="Orientation.Horizontal" class="w-100 p-3">

                <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="Registrar nuevo consignador" Click="@HandleCreateConsignor" />

                <FilterControls LogicalFilterValue="@logicalFilterOperator" LogicalFilterValueChanged="@(v => logicalFilterOperator = v)" LogicalFilterOnChanged="@grid.Reload" ResetButtonClicked="@ResetAsync" />

            </RadzenStack>
        </HeaderTemplate>

        <Columns>
            <RadzenDataGridColumn TItem="ConsignorDto" Sortable="false" Filterable="false" Width="80px" MinWidth="80px">

                <Template Context="consignor">
                    <RadzenSplitButton Click=@(async (args) => await OnSplitButtonClick(args, consignor)) Icon="read_more">

                        <ChildContent>
                            <RadzenSplitButtonItem Text="Ver consignador" Value="view" Icon="read_more" />
                            <RadzenSplitButtonItem Text="Editar consignador" Value="edit" Icon="edit" />
                            <RadzenSplitButtonItem Text="Eliminar consignador" Value="delete" Icon="delete" />
                        </ChildContent>

                    </RadzenSplitButton>
                </Template>

            </RadzenDataGridColumn>

            <RadzenDataGridColumn Property="Id" Title="Código" MinWidth="80px" Width="80px" />

            <RadzenDataGridColumn TItem="ConsignorDto" Property="CommissionPercent" Title="Comisión (%)" MinWidth="140px" Width="140px">
                <Template Context="data">
                    @($"{data.CommissionPercent:0}%")
                </Template>
            </RadzenDataGridColumn>


            <RadzenDataGridColumn Filterable="false" Property="TotalConsignments" Title="Cant. consignaciones" MinWidth="80px" Width="180px">
                <Template Context="consignor">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <RadzenText>@consignor.TotalConsignments</RadzenText>
                        @if (consignor.TotalConsignments > 0)
                        {
                            <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(async() => await ShowConsignorConsignments(consignor))" />
                        }
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Property="FullName" Title="Nombre completo" MinWidth="200px" Width="220px" />

            <RadzenDataGridColumn Property="CreatedAt" Title="Creado el" FormatString="{0:dd/MM/yyyy HH:mm}" MinWidth="140px" Width="160px" />

            <RadzenDataGridColumn Filterable="false" Sortable="false" TItem="ConsignorDto" Title="Acciones" MinWidth="200px" Width="160px">

                <Template Context="consignor">

                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(async() => await HandleEditConsignor(consignor))" />

                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Medium" Shade="Shade.Lighter" class="rz-my-1 rz-ms-1" Click="@(async() => await HandleDeleteConsignor(consignor))" />

                    <RadzenButton Icon="read_more" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(() => ViewConsignor(consignor.Id))" />

                </Template>
            </RadzenDataGridColumn>

        </Columns>
    </RadzenDataGrid>
</RadzenCard>

@code {
    private RadzenDataGrid<ConsignorDto> grid = null!;
    private IEnumerable<ConsignorDto>? consignors;
    private IList<ConsignorDto>? selectedConsignors;
    private int count;
    private bool isLoading = false;
    private string GridMessage = "No hay consignadores para mostrar.";

    private LogicalFilterOperator logicalFilterOperator = RadzenDataGridDefaults.FilterOperator;

    async Task LoadConsignors(LoadDataArgs args)
    {
        if (isLoading) return;

        isLoading = true;

        QueryRequest request = RadzenQueryRequestMapper.ConvertToQueryRequest(args, logicalFilterOperator);

        var result = await ConsignorService.GetAllAsync(request, CancellationToken.None);
        if (result.IsSuccess)
        {
            consignors = result.Value.Items;
            count = result.Value.Count;
            selectedConsignors = consignors.Take(1).ToList();
        }
        else
        {
            consignors = [];
            selectedConsignors = [];
            count = 0;
            GridMessage = result.Error.Description;
        }

        isLoading = false;

    }

    private void ViewConsignor(int consignorId)
    {
        NavigationManager.NavigateTo($"/consignadores/{consignorId}");
    }

    private async Task HandleEditConsignor(ConsignorDto consignor)
    {
        var result = await DialogService.OpenAsync<EditConsignorForm>($"Editar consignador",
               new Dictionary<string, object>() { { "ConsignorDto", consignor } },
               new DialogOptions()
               {
                   Width = "50%",
                   CloseDialogOnOverlayClick = true
               }
        );

        if (result is Result editResult)
        {
            if (editResult.IsSuccess)
            {
                SimpleNotifications.Success($"Consignador editado con éxito.");
                await grid.Reload();
            }
            else
            {
                SimpleNotifications.Error($"Error: {editResult.Error.Description}");
            }
        }
    }

    private async Task HandleDeleteConsignor(ConsignorDto consignor)
    {
        var result = await DialogService.OpenAsync<DeleteConsignorConfirmation>($"Confirmar eliminación",
        new Dictionary<string, object>() { { "ConsignorDto", consignor } },
        new DialogOptions()
        {
            CloseDialogOnOverlayClick = true
        }
        );
        if (result is Result deleteResult)
        {
            if (deleteResult.IsSuccess)
            {
                SimpleNotifications.Success($"Consignador eliminado con éxito.");
                await grid.Reload();
            }
            else
            {
                SimpleNotifications.Error($"Error: {deleteResult.Error.Description}");
            }
        }
    }

    private async Task HandleCreateConsignor()
    {
        var result = await DialogService.OpenAsync<CreateConsignorForm>("Registrar nuevo consignador",
               new Dictionary<string, object>(),
               new DialogOptions()
               {
                   Width = "50%",
                   CloseDialogOnOverlayClick = true
               }
        );
        if (result is Result<int> createResult)
        {
            if (createResult.IsSuccess)
            {
                SimpleNotifications.Success($"Consignador creado con éxito!");
                NavigationManager.NavigateTo($"/consignadores/{createResult.Value}");
            }
            else
            {
                SimpleNotifications.Error($"Error: {createResult.Error.Description}");
            }
        }
    }

    private async Task OnSplitButtonClick(RadzenSplitButtonItem item, ConsignorDto consignor)
    {
        if (consignor == null)
        {
            return;
        }

        if (item == null)
        {
            ViewConsignor(consignor.Id);
            return;
        }

        switch (item.Value)
        {
            case "view":
                ViewConsignor(consignor.Id);
                break;
            case "edit":
                await HandleEditConsignor(consignor);
                break;
            case "delete":
                await HandleDeleteConsignor(consignor);
                break;
        }
    }

    private async Task ShowConsignorConsignments(ConsignorDto consignor)
    {
       await DialogService.OpenAsync<ConsignorConsignmentsGrid>($"Consignaciones del consignador '{consignor.FirstName} {consignor.LastName}' código '{consignor.Id}'",
       new Dictionary<string, object>() { { "ConsignorId", consignor.Id } },
       new DialogOptions()
       {
           Width = "75%",
           CloseDialogOnOverlayClick = true
       });
    }

    async Task ResetAsync()
    {
        grid.Reset(true);
        await grid.FirstPage(true);
    }
}
