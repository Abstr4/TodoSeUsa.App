@page "/cajas"

@using TodoSeUsa.Application.Features.Boxes.DTOs
@using TodoSeUsa.Application.Features.Boxes.Interfaces
@using TodoSeUsa.BlazorServer.Features.Shared

@inject IBoxService BoxService;

@inject DialogService DialogService;
@inject NavigationManager NavigationManager;
@inject SimpleNotifications SimpleNotifications;

@rendermode InteractiveServer

@attribute [Authorize]

<style>
    .rz-custom-header {
        width: 100%;
    }
</style>

<RadzenCard Style="max-width: 100%">

    <PageTitleWithBackButton Title="Cajas" />

    <RadzenDataGrid @ref="grid" IsLoading="@isLoading" TItem="BoxDto" Data="@boxes" Count="@count" EmptyText="@EmptyBoxesMessage" LogicalFilterOperator="@logicalFilterOperator" @bind-Value="@selectedBoxes" LoadData="@LoadBoxes" SelectionMode="DataGridSelectionMode.Single" PageSize="5" AllowSorting=true AllowFiltering=true AllowPaging=true AllowColumnResize=true FilterMode="FilterMode.Simple" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" GridLines="DataGridGridLines.Both" PagerHorizontalAlign="HorizontalAlign.Center" ClearFilterText="Limpiar" ApplyFilterText="Aplicar" FilterText="Filtro" ContainsText="Contiene" EqualsText="Equivale" AndOperatorText="Y" OrOperatorText="O" LessThanOrEqualsText="Menor o igual que" LessThanText="Menor que" GreaterThanOrEqualsText="Mayor o igual que" GreaterThanText="Mayor que" NotEqualsText="No es igual a" IsNullText="Es nulo" IsNotNullText="No es nulo">

        <HeaderTemplate>
            <RadzenStack Wrap="FlexWrap.Wrap" JustifyContent="JustifyContent.SpaceBetween" Orientation="Orientation.Horizontal" class="w-100 p-3">

                <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="Registrar nueva caja" Click="@HandleCreateBox" />

                <FilterControls LogicalFilterValue="@logicalFilterOperator" LogicalFilterValueChanged="@(v => logicalFilterOperator = v)" LogicalFilterOnChanged="@grid.Reload" ResetButtonClicked="@ResetAsync" />

            </RadzenStack>
        </HeaderTemplate>

        <Columns>

            <RadzenDataGridColumn TItem="BoxDto" Sortable="false" Filterable="false" Width="60px" MinWidth="60px">

                <Template Context="box">
                    <RadzenSplitButton Click=@(async (args) => await OnSplitButtonClick(args, box)) Icon="read_more">

                        <ChildContent>
                            <RadzenSplitButtonItem Text="Agregar producto(s)" Value="add_product" Icon="add" />
                            <RadzenSplitButtonItem Text="Ver" Value="view" Icon="read_more" />
                            <RadzenSplitButtonItem Text="Editar" Value="edit" Icon="edit" />
                            <RadzenSplitButtonItem Text="Eliminar" Value="delete" Icon="delete" />
                        </ChildContent>

                    </RadzenSplitButton>
                </Template>

            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="BoxDto" Property="@nameof(BoxDto.Id)" Title="Código" MinWidth="120px" Width="120px" Filterable="true" Sortable="true">
                <Template Context="box">
                    BOX-@box.Id.ToString()
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Filterable="false" Property="@nameof(BoxDto.TotalProducts)" Title="Cant. productos" MinWidth="120px" Width="120px">

                <Template Context="box">

                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">

                        <RadzenText>@box.TotalProducts</RadzenText>
                        @if (box.TotalProducts > 0)
                        {
                            <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(async () => await ShowBoxProducts(box))" />
                        }
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Property="@nameof(BoxDto.Location)" Title="Ubicación" MinWidth="120px" Width="200px" />

            <RadzenDataGridColumn Property="@nameof(BoxDto.CreatedAt)" Title="Creada el" FormatString="{0:dd/MM/yyyy HH:mm}" MinWidth="120px" Width="120px" />

            <RadzenDataGridColumn Sortable="false" TItem="BoxDto" Title="Acciones" MinWidth="120px" Width="120px">
                <Template Context="box">
                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(async () => await HandleEditBox(box))" />

                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Medium" Shade="Shade.Lighter" class="rz-my-1 rz-ms-1" Click="@(async () => await HandleDeleteBox(box))" />

                    <RadzenButton Icon="read_more" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(() => ViewBox(box.Id))" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>

    </RadzenDataGrid>
</RadzenCard>

@code {
    private RadzenDataGrid<BoxDto> grid = null!;

    private IEnumerable<BoxDto>? boxes;
    private IList<BoxDto>? selectedBoxes;
    private int count;
    private bool isLoading = false;

    private string EmptyBoxesMessage = "No hay cajas para mostrar.";

    private LogicalFilterOperator logicalFilterOperator = RadzenDataGridDefaults.FilterOperator;

    async Task LoadBoxes(LoadDataArgs args)
    {
        if (isLoading) return;

        isLoading = true;

        QueryRequest request = RadzenQueryRequestMapper.ConvertToQueryRequest(args, logicalFilterOperator);

        var result = await BoxService.GetAllAsync(request, CancellationToken.None);
        if (result.IsSuccess)
        {
            boxes = result.Value.Items;
            count = result.Value.Count;
        }
        else
        {
            boxes = [];
            selectedBoxes = [];
            count = 0;
            EmptyBoxesMessage = result.Error.Description;
        }

        isLoading = false;
    }

    private void ViewBox(int boxId)
    {
        NavigationManager.NavigateTo($"/cajas/{boxId}");
    }

    private async Task HandleEditBox(BoxDto boxDto)
    {
        var result = await DialogService.OpenAsync<EditBoxForm>($"Editar caja código 'BOX-{boxDto.Id}'",
            new Dictionary<string, object>() { { "BoxDto", boxDto } },
            new DialogOptions()
            {
                CloseDialogOnOverlayClick = true
            }
        );

        if (result is Result editResult)
        {
            if (editResult.IsSuccess)
            {
                SimpleNotifications.Success($"Caja editada con éxito.");
                await grid.Reload();
            }
            else
            {
                SimpleNotifications.Error($"Error: {editResult.Error.Description}");
            }
        }
    }

    private async Task HandleDeleteBox(BoxDto boxDto)
    {
        var result = await DialogService.OpenAsync<DeleteBoxConfirmation>($"Confirmar eliminación",
        new Dictionary<string, object>() { { "BoxDto", boxDto } },
        new DialogOptions()
        {
            CloseDialogOnOverlayClick = true
        }
        );
        if (result is Result deleteResult)
        {
            if (deleteResult.IsSuccess)
            {
                SimpleNotifications.Success($"Caja eliminada con éxito.");
                await grid.Reload();
            }
            else
            {
                SimpleNotifications.Error($"Error: {deleteResult.Error.Description}");
            }
        }
    }

    private async Task HandleCreateBox()
    {
        var result = await DialogService.OpenAsync<CreateBoxForm>("Registrar nueva caja",
            new Dictionary<string, object>(),
            new DialogOptions()
            {
                CloseDialogOnOverlayClick = true
            }
        );
        if (result is Result<int> createResult)
        {
            if (createResult.IsSuccess)
            {
                SimpleNotifications.Success($"Caja creada con éxito!");
                NavigationManager.NavigateTo($"/cajas/{createResult.Value}");
            }
            else
            {
                SimpleNotifications.Error($"Error: {createResult.Error.Description}");
            }
        }
    }

    public async Task ShowBoxProducts(BoxDto boxDto)
    {
        await DialogService.OpenAsync<BoxProductsGrid>($"Productos en la caja código 'BOX-{boxDto.Id}'",
            new Dictionary<string, object>() { { "BoxDto", boxDto } },
            new DialogOptions()
            {
                Width = "75%",
                CloseDialogOnOverlayClick = true
            }
        );

    }

    public async Task AddProductToBox(BoxDto box)
    {
        var result = await DialogService.OpenAsync<AddProductsToBox>($"Agregar productos a la caja código 'BOX-{box.Id}'",
            new Dictionary<string, object>() { { "BoxDto", box } },
            new DialogOptions()
            {
                Height = "80%",
                CloseDialogOnOverlayClick = true
            }
        );

        if (result is Result addProductsResult)
        {
            if (addProductsResult.IsSuccess)
            {
                SimpleNotifications.Success($"Los productos se agregaron a la caja.");
                await ResetAsync();
            }
            else
            {
                SimpleNotifications.Error($"No se pudieron agregar los productos a la caja.");
            }
        }
    }

    private async Task OnSplitButtonClick(RadzenSplitButtonItem item, BoxDto box)
    {
        if (box == null) return;

        if (item == null)
        {
            ViewBox(box.Id);
            return;
        }

        switch (item.Value)
        {
            case "add_product":
                await AddProductToBox(box);
                break;
            case "view":
                ViewBox(box.Id);
                break;
            case "edit":
                await HandleEditBox(box);
                break;
            case "delete":
                await HandleDeleteBox(box);
                break;
        }
    }

    async Task ResetAsync()
    {
        grid.Reset(true);
        await grid.FirstPage(true);
    }
}
