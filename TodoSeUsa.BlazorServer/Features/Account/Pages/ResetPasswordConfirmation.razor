@page "/Cuenta/ContraseñaReseteada"

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using TodoSeUsa.Infrastructure.Data

@inject IDbContextFactory<ApplicationDbContext> DbContextFactory;
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<style>
    .copy-btn {
        position: absolute;
        top: 60%;
        right: 6px;
        transform: translateY(-50%);
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 0;
    }

    .copy-btn::after {
        content: "Copiado al portapapeles";
        position: absolute;
        right: 28px;
        top: 50%;
        transform: translateY(-50%) translateY(2px);
        background: #222;
        color: white;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 6px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity .18s ease, transform .18s ease;
    }

    .copy-btn.copied::after {
        opacity: 1;
        transform: translateY(-50%) translateY(-4px);
    }

    #downloadBtn {
        background-color: #6c757d;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }

    #continueBtn {
        background-color: #0d6efd;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }

    #downloadBtn:hover, #continueBtn:hover {
        opacity: 0.9;
    }

</style>

<RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center" class="page-wrapper">

    <RadzenCard>

        <h1 style="margin-bottom:1rem;">Cambiaste tu contraseña</h1>

        <RadzenText Style="margin-bottom: 1rem">
            Si la pierdes de nuevo, este código es tu mecanismo de seguridad para recuperarla.
        </RadzenText>

        <RadzenStack Orientation="Orientation.Vertical">


            <RadzenLabel Component="recovery-code">Código de recuperación</RadzenLabel>

            <RadzenStack Orientation="Orientation.Horizontal">

                <div style="position: relative; width: 100%; margin-left: 6px">

                    <RadzenTextBox Name="recovery-code" Value="@RecoveryCode" ReadOnly="true" Style="width: 100%; padding-right: 34px;" />

                    <button class="copy-btn" type="button" onclick="copyRecoveryCode('@RecoveryCode', this)">
                        <RadzenIcon Icon="content_copy" />
                    </button>

                </div>

                <RadzenButton id="downloadBtn" Icon="download"></RadzenButton>

                <span id="recoveryCode" style="display:none">@RecoveryCode</span>


            </RadzenStack>

            <RadzenAlert AlertStyle="AlertStyle.Warning" Style="margin-top:10px" AllowClose="false">
                <RadzenText>
                    Guarda este código en un lugar seguro. No podrás verlo de nuevo.
                </RadzenText>
            </RadzenAlert>

            <RadzenButton id="continueBtn">Continuar</RadzenButton>

        </RadzenStack>

    </RadzenCard>
</RadzenStack>

@code {

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    public string? RecoveryCode { get; set; }

    protected override void OnInitialized()
    {
        var code = HttpContext.Session.GetString("RecoveryCode");

        HttpContext.Session.Remove("RecoveryCode");

        if (string.IsNullOrWhiteSpace(code))
        {
            NavigationManager.NavigateTo("/error");
            return;
        }

        RecoveryCode = code;
    }
}