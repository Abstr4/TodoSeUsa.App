@using TodoSeUsa.Application.Features.Consignments.DTOs
@using TodoSeUsa.Application.Features.Consignments.Interfaces
@using TodoSeUsa.BlazorServer.Validation

@inject IConsignmentService ConsignmentService;

@inject DialogService DialogService;

@attribute [Authorize]

<RadzenTemplateForm TItem="CreateConsignmentDto" Data=@createConsignmentDto Submit=@OnSubmit>

    <RadzenStack Gap="1rem">
        <RadzenFieldset Text="Info. de la consignación">
            <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
                <RadzenRow>

                    <RadzenColumn Size="6" id="ConsignorId-column">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                            <RadzenLabel Component="ConsignorId">
                                Código del consignador <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>

                            <RadzenNumeric Name="ConsignorId" @bind-Value=@createConsignmentDto.ConsignorId Style="width: 100%;" TValue="int" Min="0" Disabled="@(ConsignorId != null)" />
                            <RadzenRequiredValidator Component="ConsignorId" Text="El código del consignador es requerido." />
                            <RadzenNumericRangeValidator Component="ConsignorId" Min="1" Text="El código del consignador debe ser mayor a cero." />

                        </RadzenStack>
                    </RadzenColumn>

                    <RadzenColumn Size="6" id="dateIssued-column">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                            <RadzenLabel Component="DateIssued">
                                Fecha de emisión <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>

                            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                <RadzenDatePicker Max="DateTime.Now" Name="DateIssued" @bind-Value=@createConsignmentDto.DateIssued Style="flex-grow: 1;" Placeholder="Fecha de emisión..." />

                            </RadzenStack>

                            <RadzenCustomValidator Validator="@(() => createConsignmentDto.DateIssued is null || createConsignmentDto.DateIssued <= DateTime.Now)" Text="La fecha debe estar en el pasado." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="6" id="notes-column">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                            <RadzenLabel Component="Notes">
                                Notas <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenTextBox MaxLength="250" Name="Notes" @bind-Value=@createConsignmentDto.Notes Style="width: 100%;" Change="@OnNotesChanged" Placeholder="Notas..." />

                            <RadzenCustomValidator Component="Notes"
                                                  Validator="(() => InputValidators.IsNullOrEmptyOrMatchesAlphanumericPattern(createConsignmentDto.Notes))"
                                                  Text="Las notas no pueden ser solo espacios o símbolos." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenFieldset>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="1rem" class="rz-mt-8">
            <RadzenButton IsBusy="@isCreating" BusyText="Creando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Crear" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code
{
    [Parameter] public int? ConsignorId { get; set; }

    private bool isCreating;

    private CreateConsignmentDto createConsignmentDto = new();

    protected override void OnInitialized()
    {
        if (ConsignorId != null && ConsignorId > 0)
        {
            createConsignmentDto.ConsignorId = ConsignorId.Value;
        }
    }

    async Task OnSubmit(CreateConsignmentDto createConsignmentDto)
    {
        isCreating = true;
        var result = await ConsignmentService.CreateAsync(createConsignmentDto, CancellationToken.None);
        isCreating = false;
        DialogService.Close(result);
    }

    private void OnNotesChanged(string? value)
    {
        createConsignmentDto.Notes = value == "" ? null : value;
        StateHasChanged();
    }
}

