@page "/Account/ForgotPassword"

@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@using TodoSeUsa.Application.Security
@using TodoSeUsa.Infrastructure.Data

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject IRecoveryCodeHasher RecoveryCodeHasher

<PageTitle>¿Olvidaste tu contraseña?</PageTitle>

<style>
    .btn {
        width: 100%;
        padding: 0.6rem;
    }
    .form-label
    {
        margin-bottom: 2px;
    }
</style>

<RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center">

    <h1>¿Olvidaste tu contraseña?</h1>

    <RadzenCard Style="max-width: 480px">

        <h2>Recuperar mi cuenta</h2>
        <hr />

        <RadzenStack Style="margin-bottom: 2rem">
            <RadzenText>Para recuperar el acceso a su cuenta, ingrese el email con el que se registró y el código de recuperación que guardó en un lugar seguro.</RadzenText>
            <RadzenText>Si el email y el código ingresados son válidos, podrás cambiar la contraseña de tu cuenta.</RadzenText>
        </RadzenStack>

        <RadzenStack Style="width: 100%">

            <EditForm Model="this" method="post" OnValidSubmit="OnValidSubmitAsync" FormName="ForgotPasswordForm">
                <DataAnnotationsValidator />

                    <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0px">

                            <label for="Input.Email" class="form-label">Email</label>
                            <InputText @bind-Value="Input.Email" id="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="nombre@ejemplo.com" style="width: 100%;"/>
                            <ValidationMessage For="() => Input.Email" class="text-danger" />

                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0px" Style="margin-bottom: 1rem">

                            <label for="Input.RecoveryCode" class="form-label">RecoveryCode</label>
                            <InputText @bind-Value="Input.RecoveryCode" id="Input.RecoveryCode" class="form-control" autocomplete="recoveryCode" aria-required="true" placeholder="AAAA1111BBBB2222CCCC3333" style="width: 100%;"/>
                            <ValidationMessage For="() => Input.RecoveryCode" class="text-danger" />

                        </RadzenStack>

                        <RadzenButton ButtonType="ButtonType.Submit">Verificar</RadzenButton>
                    </RadzenStack>

                </EditForm>
        </RadzenStack>

        @if (errors.Count > 0)
        {
            foreach (var error in errors)
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger" ShowIcon="false" Variant="Variant.Flat" Shade="Shade.Lighter">
                    @error
                </RadzenAlert>
            }
        }
    </RadzenCard>
</RadzenStack>

@code {

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private List<string> errors = [];

    private async Task OnValidSubmitAsync()
    {
        errors.Clear();

        var user = await UserManager.FindByEmailAsync(Input.Email);

        if (user is null)
        {
            errors.Add("Usuario incorrecto.");
            return;
        }

        var matches = RecoveryCodeHasher.Verify(Input.RecoveryCode, user.RecoveryCodeHash);

        if (!matches)
        {
            errors.Add("Código de recuperación incorrecto.");
            return;
        }

        HttpContext.Session.SetString("PasswordRecoveryUserId", user.Id);
        HttpContext.Session.SetString("PasswordRecoveryVerified", "true");

        NavigationManager.NavigateTo("/Account/ResetPassword");
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Ingrese un email.")]
        [EmailAddress(ErrorMessage = "Ingrese un email válido.")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Ingrese un código de recuperación.")]
        public string RecoveryCode { get; set; } = "";
    }
}
