@page "/consignaciones/{Id:int}"

@using TodoSeUsa.Application.Features.Consignments.DTOs
@using TodoSeUsa.Application.Features.Consignments.Interfaces
@using TodoSeUsa.Application.Features.Products.DTOs
@using TodoSeUsa.Application.Features.Products.Interfaces
@using TodoSeUsa.BlazorServer.Components.Pages.Products

@inject IConsignmentService ConsignmentService;
@inject IProductService ProductService;

@inject NavigationManager NavigationManager;
@inject DialogService DialogService;
@inject SimpleNotifications SimpleNotifications;
@inject IJSRuntime JS;

@attribute [Authorize]

<style>
    .rz-fieldset-toggler {
        font-weight: 800;
        width: 25px;
        height: 25px;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid;
        border-radius: 25%;
    }

    table h6, .subtitle1 {
        margin: 0 !important;
    }
</style>

<RadzenStack JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center" Style=" padding-bottom: 1.1rem">
    @if (isLoading)
    {
        <ScreenLoading />
    }
    else if (consignment != null)
    {
        <RadzenCard class="rz-shadow-5" Style="width: 100%; min-width: calc(250px + 2*(2rem));">

            <RadzenStack Gap="1rem">

                    <RadzenStack id="top-action-buttons" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" 
                        JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap">

                        <RadzenButton Click="@(() => JS.GoBackOrHomeAsync(NavigationManager, "/"))" Icon="arrow_back" Text="Volver" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium" />

                        <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                            <RadzenButton Icon="add" Text="Agregar producto a la consignación" ButtonStyle="ButtonStyle.Success"
                                        Click=@HandleAddProduct Style="flex-grow: 1;" />

                            <RadzenButton Icon="edit" Text="Editar" ButtonStyle="ButtonStyle.Warning"
                                        Click=@HandleEditConsignment Style="flex-grow: 1;" />

                            <RadzenButton  Icon="delete" Text="Borrar" ButtonStyle="ButtonStyle.Danger"
                                            Click=@HandleDeleteConsignment Style="flex-grow: 1;" />
                        </RadzenStack>
                    </RadzenStack>

                    <RadzenText TextStyle="TextStyle.H4" Style="margin: 1rem 0; text-align: center !important">Detalles de consignación </RadzenText>

                    <RadzenTable id="sale-details-table" Style="border:1px solid #ddd; border-radius:8px; width:100%; margin-top:1rem;">

                        <RadzenTableHeader>

                            <RadzenTableHeaderRow>

                                <RadzenTableHeaderCell style="width: 40%; font-weight:bold;" id="property-header">
                                    <RadzenText TextStyle="TextStyle.H6" Text="Propiedad" />
                                </RadzenTableHeaderCell>

                                <RadzenTableHeaderCell style="width: 60%; font-weight:bold;" id="value-header">
                                    <RadzenText TextStyle="TextStyle.H6" Text="Valor" />
                                </RadzenTableHeaderCell>
                            </RadzenTableHeaderRow>
                        </RadzenTableHeader>

                        <RadzenTableBody>

                            <RadzenTableRow id="id-row">

                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="Código interno" style="font-weight:bold" />
                                </RadzenTableCell>
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="@consignment.Id.ToString()" />
                                </RadzenTableCell>
                            </RadzenTableRow>

                            <RadzenTableRow id="code-row">

                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="Código público" style="font-weight:bold" />
                                </RadzenTableCell>
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="@consignment.Code" />
                                </RadzenTableCell>
                            </RadzenTableRow>

                            <RadzenTableRow id="consignor-row">

                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="Consignador" style="font-weight:bold" />
                                </RadzenTableCell>
                                <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1">
                                    @consignment.ConsignorFullName - Código '@consignment.ConsignorId.ToString()'
                                    <RadzenLink Path=@($"/consignadores/{consignment.ConsignorId}") style="vertical-align: super">
                                        <RadzenIcon Icon="info" IconStyle="IconStyle.Info" />
                                    </RadzenLink>
                                </RadzenText>
                                </RadzenTableCell>
                            </RadzenTableRow>

                            <RadzenTableRow id="notes-row">

                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="Notas" style="font-weight:bold" />
                                </RadzenTableCell>
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1"> @(string.IsNullOrWhiteSpace(consignment.Notes) ? "N/A" : consignment.Notes)</RadzenText>
                                </RadzenTableCell>
                            </RadzenTableRow>

                            <RadzenTableRow id="totalProducts-row">
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="Productos en la consignación" style="font-weight:bold;" />
                                </RadzenTableCell>
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="@consignment.TotalProducts.ToString()" />
                                </RadzenTableCell>
                            </RadzenTableRow>

                            <RadzenTableRow id="issuedAt-row">
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="Emitida el" style="font-weight:bold;" />
                                </RadzenTableCell>
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="@consignment.DateIssued.ToString("f")" />
                                </RadzenTableCell>
                            </RadzenTableRow>

                            <RadzenTableRow id="createdAt-row">
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="Creada el" style="font-weight:bold;" />
                                </RadzenTableCell>
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="@consignment.CreatedAt.ToString("f")" />
                                </RadzenTableCell>
                            </RadzenTableRow>

                            <RadzenTableRow id="updatedAt-row">
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Text="Actualizada el" style="font-weight:bold;" />
                                </RadzenTableCell>
                                <RadzenTableCell>
                                    <RadzenText TextStyle="TextStyle.Subtitle1" >
                                    @(consignment.UpdatedAt is null ? "N/A" : consignment.UpdatedAt.Value.ToString("f"))</RadzenText>
                                </RadzenTableCell>
                            </RadzenTableRow>
                        </RadzenTableBody>

                    </RadzenTable>

                    <RadzenFieldset AllowCollapse="true" Collapsed="false" class="w-100 rz-mt-4">

                    <HeaderTemplate>
                        <RadzenText TextStyle="TextStyle.H6" class="rz-display-flex rz-align-items-center rz-m-0">
                            <RadzenIcon Style="font-size: 20px" Icon="account_box" class="rz-me-1" /><b>Productos en la consignación</b>
                        </RadzenText>
                    </HeaderTemplate>

                    <ChildContent>
                        <ProductsDataGrid @ref="productsGrid" OnLoad="@LoadProductsByConsignment" IsMainPage=false />
                    </ChildContent>

                    <SummaryTemplate>
                        <RadzenCard Variant="Variant.Outlined" class="rz-mt-4">
                            <b>@consignment.TotalProducts Productos</b>
                        </RadzenCard>
                    </SummaryTemplate>

                </RadzenFieldset>
                    

                </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter" Text="@errorMessage" />
        <RadzenButton Icon="arrow_back" Text="Volver" Click="@(() => JS.GoBackOrHomeAsync(NavigationManager, "/"))" />
    }
</RadzenStack>


@code {
    [Parameter] public int Id { get; set; }

    private ProductsDataGrid productsGrid = null!;

    private ConsignmentDto? consignment;
    private bool isLoading = false;

    private string? errorMessage;

    private LogicalFilterOperator logicalFilterOperator = RadzenDataGridDefaults.FilterOperator;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var result = await ConsignmentService.GetByIdAsync(Id, CancellationToken.None);
        if (result.IsSuccess)
        {
            consignment = result.Value;
        }
        else
        {
            errorMessage = result.Error.Description;
        }
        isLoading = false;
    }

    private async Task<Result<PagedItems<ProductDto>>> LoadProductsByConsignment(LoadDataArgs args)
    {
        var request = RadzenQueryRequestMapper.ConvertToQueryRequest(args, logicalFilterOperator);
        return await ProductService.GetByConsignmentIdAsync(request, Id, CancellationToken.None);
    }

    private async Task HandleAddProductDialog()
    {
        var result = await DialogService.OpenAsync<CreateProductForm>("Registrar nuevo producto",
            new Dictionary<string, object>() { { "ConsignmentId", Id } },
            new DialogOptions()
           {
               Width = "50%",
               CloseDialogOnOverlayClick = true
           }
        );
        if (result is Result createResult)
        {
            if (createResult.IsSuccess)
            {
                SimpleNotifications.Success($"Producto creado con éxito!");
                await productsGrid.ResetAsync();
            }
            else
            {
                SimpleNotifications.Error($"Error: {createResult.Error.Description}");
            }
        }
    }

    private void HandleAddProduct()
    {
        NavigationManager.NavigateTo($"productos/registrar?consignacion={Id}");
    }

    private async Task HandleEditConsignment()
    {
        if (consignment is null) return;

        var result = await DialogService.OpenAsync<EditConsignmentForm>($"Editar consignación código",
               new Dictionary<string, object>() { { "ConsignmentDto", consignment } },
               new DialogOptions()
               {
                   Width = "50%",
                   CloseDialogOnOverlayClick = true
               }
        );

        if (result is Result editResult)
        {
            if (editResult.IsSuccess)
            {
                SimpleNotifications.Success($"Consignación editada con éxito.");

                var refreshed = await ConsignmentService.GetByIdAsync(consignment.Id, CancellationToken.None);
                if (refreshed.IsSuccess)
                {
                    consignment = refreshed.Value;
                }
                StateHasChanged();
            }
            else
            {
                SimpleNotifications.Error($"Error: {editResult.Error.Description}");
            }
        }
    }

    private async Task HandleDeleteConsignment()
    {
        if (consignment is null) return;

        var result = await DialogService.OpenAsync<DeleteConsignmentConfirmation>($"Confirmar eliminación",
        new Dictionary<string, object>() { { "ConsignmentDto", consignment } },
        new DialogOptions()
        {
            CloseDialogOnOverlayClick = true
        }
        );
        if (result is Result deleteResult)
        {
            if (deleteResult.IsSuccess)
            {
                SimpleNotifications.Success($"Consignación eliminada con éxito.");
                await NavigationHelpers.GoBackOrHomeAsync(JS, NavigationManager, "/consignments");
            }
            else
            {
                SimpleNotifications.Error($"Error: {deleteResult.Error.Description}");
            }
        }
    }
}
