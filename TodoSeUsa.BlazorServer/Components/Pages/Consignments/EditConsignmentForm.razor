@using TodoSeUsa.Application.Features.Consignments.DTOs
@using TodoSeUsa.Application.Features.Consignments.Interfaces
@using TodoSeUsa.BlazorServer.UI.Notifications

@inject IConsignmentService _consignmentService;

@inject DialogService _dialogService;
@inject SimpleNotifications _simpleNotifications;


<RadzenTemplateForm TItem="EditConsignmentDto" Data=@_editConsignmentDto Submit=@OnSubmit>
    <RadzenStack Gap="1rem">
        <RadzenFieldset Text="Info. de la consignación">
            <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
                <RadzenRow>
                    <RadzenColumn Size="6" id="ProviderId-column">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                            <RadzenLabel Component="ProviderId">
                                ID del proveedor <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenNumeric Name="ProviderId" @bind-Value=@_editConsignmentDto.ProviderId Style="width: 100%;" TValue="int" Min="0" />
                            <RadzenRequiredValidator Component="ProviderId" Text="El ID del proveedor es requerido." />
                            <RadzenNumericRangeValidator Component="ProviderId" Min="1" Text="El ID del proveedor debe ser mayor a cero." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="6" id="dateIssued-column">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                            <RadzenLabel Component="DateIssued">
                                Fecha de emisión <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>

                            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                <RadzenDatePicker Max="DateTime.Now" Name="DateIssued" @bind-Value=@_editConsignmentDto.DateIssued Style="flex-grow: 1;" Change="@OnDateIssuedChanged" Placeholder="Fecha de emisión..." />

                                <RadzenButton Icon="alarm" Click="@(() => _editConsignmentDto.DateIssued = DateTime.Now)" Text="Ahora" />
                            </RadzenStack>

                            <RadzenRequiredValidator Component="DateIssued" Text="La fecha de emisión es requerida." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="6" id="notes-column">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                            <RadzenLabel Component="Notes">
                                Notas <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenTextBox Name="Notes" @bind-Value=@_editConsignmentDto.Notes Style="width: 100%;" Change="@OnNotesChanged" Placeholder="Notas..." />

                            <RadzenRegexValidator Component="Notes"
                                                  Pattern="^(?=.*[A-Za-z0-9]).{1,250}$"
                                                  Text="Las notas deben tener entre 1 y 250 caracteres válidos (no solo espacios o símbolos)." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenStack AlignItems="AlignItems.End" JustifyContent="JustifyContent.End" class="rz-mt-4">
                    <RadzenButton Icon="reset_settings" Click="@SetEditDtoToOriginal" Text="Resetear" />
                </RadzenStack>

            </RadzenStack>
        </RadzenFieldset>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" class="rz-mt-8">

            <RadzenButton IsBusy=@_busy BusyText="Guardando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Guardar" Disabled=!HasChanges() />

            <RadzenButton Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Base" Icon="cancel" Text="Cancelar" Click="@(() => _dialogService.Close())" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code
{
    [Parameter] public required ConsignmentDto ConsignmentDto { get; set; }

    private bool _busy;

    private EditConsignmentDto _editConsignmentDto = new();

    protected override void OnInitialized()
    {
        SetEditDtoToOriginal();
    }

    async Task OnSubmit(EditConsignmentDto _editConsignmentDto)
    {
        _busy = true;
        var result = await _consignmentService.EditByIdAsync(_editConsignmentDto, CancellationToken.None);
        _busy = false;
        _dialogService.Close(result);
    }

    private void OnNotesChanged(string? value)
    {
        _editConsignmentDto.Notes = value == "" ? null : value;
        StateHasChanged();
    }

    private void OnDateIssuedChanged(DateTime? value)
    {
        if (value != null)
        {
            _editConsignmentDto.DateIssued = value.Value;
            StateHasChanged();
        }
        else
        {
            _editConsignmentDto.DateIssued = DateTime.Now;
        }
    }

    private void SetEditDtoToOriginal()
    {
        _editConsignmentDto = new EditConsignmentDto
        {
            Id = ConsignmentDto.Id,
            ProviderId = ConsignmentDto.ProviderId,
            DateIssued = ConsignmentDto.DateIssued,
            Notes = ConsignmentDto.Notes
        };

        StateHasChanged();
    }

    private bool HasChanges()
    {
        return !string.Equals(_editConsignmentDto.Notes, ConsignmentDto.Notes, StringComparison.OrdinalIgnoreCase) ||
               _editConsignmentDto.DateIssued != ConsignmentDto.DateIssued || 
               !string.Equals(_editConsignmentDto.Notes, ConsignmentDto.Notes, StringComparison.OrdinalIgnoreCase);
    }
}

