@using System.Text.Json
@using TodoSeUsa.Application.Features.Boxes.DTOs
@using TodoSeUsa.Application.Features.Boxes.Interfaces
@using TodoSeUsa.BlazorServer.Helpers

@inject Radzen.DialogService DialogService;
@inject IBoxService BoxService;
@inject SimpleNotifications SimpleNotifications;


<RadzenTemplateForm TItem="EditBoxDto" Data=@editBoxDto Submit=@OnSubmit>
    <RadzenStack Gap="1rem">
        <RadzenFormField Text="Ubicación Física" Variant="@variant">
            <ChildContent>
                <RadzenTextBox Name="Location" @bind-Value=@editBoxDto.Location Style="border: 1px solid;" Change=@OnFieldChanged />
            </ChildContent>
            <Helper>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <RadzenLengthValidator Component="Location" Max="250" Text="La ubicación no puede tener más de 250 carácteres"></RadzenLengthValidator>
                </div>
            </Helper>
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" class="rz-mt-8">
            <RadzenButton ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Guardar" Disabled=@isSaveDisabled />
            <RadzenButton Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Base" Icon="cancel" Text="Cancelar" Click="@(() => DialogService.Close())" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>


@code {

    [Parameter] public int BoxId { get; set; }

    private Variant variant = Variant.Filled;

    private BoxDto originalDto = new();
    private EditBoxDto editBoxDto = new();
    private bool isSaveDisabled = true;

    protected override async Task OnInitializedAsync()
    {
        var result = await BoxService.GetByIdAsync(BoxId, CancellationToken.None);
        if (result.IsSuccess)
        {
            originalDto = result.Value;

            editBoxDto = new EditBoxDto
            {
                Location = originalDto.Location
            };
        }
        else
        {
            DialogService.Close();
            SimpleNotifications.Error(result.Error.ToString());
        }
    }

    private void OnFieldChanged()
    {
        isSaveDisabled = editBoxDto.Location == originalDto.Location;
        StateHasChanged();
    }

    async Task OnSubmit(EditBoxDto editBoxDto)
    {
        var result = await BoxService.EditBoxById(BoxId, editBoxDto, CancellationToken.None);
        DialogService.Close(result);
    }
}
