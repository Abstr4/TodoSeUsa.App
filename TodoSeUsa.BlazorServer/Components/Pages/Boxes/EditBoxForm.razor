@using System.Text.Json
@using TodoSeUsa.Application.Features.Boxes.DTOs
@using TodoSeUsa.Application.Features.Boxes.Interfaces
@using TodoSeUsa.BlazorServer.Helpers

@inject Radzen.DialogService DialogService;
@inject IBoxService BoxService;
@inject SimpleNotifications SimpleNotifications;


<RadzenTemplateForm TItem="EditBoxDto" Data=@editBoxDto Submit=@OnSubmit>
    <RadzenStack Gap="1rem">
        <RadzenFieldset Text="Info. de la caja">
            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                <RadzenLabel Component="Location">
                    Ubicación física
                </RadzenLabel>
                <RadzenTextBox Name="Location" @bind-Value=@editBoxDto.Location  Change=@OnFieldChanged />
                <RadzenLengthValidator Min="1" Max="250" Component="Location" Text="La ubicación debe entre 1 y 250 carácteres."></RadzenLengthValidator>
            </RadzenStack>
        </RadzenFieldset>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" class="rz-mt-8">
            <RadzenButton ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Guardar" Disabled=@isSaveDisabled />
            <RadzenButton Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Base" Icon="cancel" Text="Cancelar" Click="@(() => DialogService.Close())" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>


@code {

    [Parameter] public int BoxId { get; set; }

    private BoxDto originalDto = new();
    private EditBoxDto editBoxDto = new();
    private bool isSaveDisabled = true;

    protected override async Task OnInitializedAsync()
    {
        var result = await BoxService.GetByIdAsync(BoxId, CancellationToken.None);
        if (result.IsSuccess)
        {
            originalDto = result.Value;

            editBoxDto = new EditBoxDto
            {
                Location = originalDto.Location
            };
        }
        else
        {
            DialogService.Close();
            SimpleNotifications.Error(result.Error.ToString());
        }
    }

    private void OnFieldChanged()
    {
        isSaveDisabled = string.Equals(editBoxDto.Location, originalDto.Location, StringComparison.OrdinalIgnoreCase);
        StateHasChanged();
    }

    async Task OnSubmit(EditBoxDto editBoxDto)
    {
        var result = await BoxService.EditBoxById(BoxId, editBoxDto, CancellationToken.None);
        DialogService.Close(result);
    }
}
