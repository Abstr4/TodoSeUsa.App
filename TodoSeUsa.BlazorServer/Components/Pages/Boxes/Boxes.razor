@page "/cajas"

@using TodoSeUsa.Application.Common.Models
@using TodoSeUsa.Application.Features.Boxes.DTOs
@using TodoSeUsa.Application.Features.Boxes.Interfaces
@using TodoSeUsa.BlazorServer.Components.Pages.Tests
@using TodoSeUsa.BlazorServer.Helpers

@inject IBoxService boxService;
@inject DialogService DialogService;
@inject NavigationManager Navigation;
@inject NotificationService NotificationService;
@inject SimpleNotifications SimpleNotifications;

<PageLayoutSection Title="Cajas">
    <RadzenCard Style="max-width: 100%">
        <RadzenStack Gap="1rem">
            <RadzenCard Variant="Variant.Outlined">
                <FilterControls LogicalFilterValue="@logicalFilterOperator" LogicalFilterValueChanged="@(v => logicalFilterOperator = v)" LogicalFilterOnChanged="@(async () => await grid.Reload())" ResetButtonClicked="@ResetAsync" />
            </RadzenCard>
            <RadzenDataGrid @ref="grid"
                            style="height: 400px"
                            IsLoading="@isLoading"
                            TItem="BoxDto"
                            Data="@boxes"
                            Count="@count"
                            EmptyText="@GridMessage"
                            LogicalFilterOperator="@logicalFilterOperator"
                            @bind-Value="@selectedBoxes"
                            LoadData="@LoadData"
                            SelectionMode="DataGridSelectionMode.Single"
                            PageSize="5"
                            AllowSorting="true"
                            AllowFiltering="true"
                            AllowPaging="true"
                            FilterMode="FilterMode.Simple"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            GridLines="DataGridGridLines.Both"
                            PagerHorizontalAlign="HorizontalAlign.Center"
                            ClearFilterText="Limpiar"
                            ApplyFilterText="Aplicar"
                            FilterText="Filtro"
                            ContainsText="Contiene"
                            EqualsText="Equivale"
                            AndOperatorText="Y"
                            OrOperatorText="O"
                            LessThanOrEqualsText="Menor o igual que"
                            LessThanText="Menor que"
                            GreaterThanOrEqualsText="Mayor o igual que"
                            GreaterThanText="Mayor que"
                            NotEqualsText="No es igual a"
                            IsNullText="Es nulo"
                            IsNotNullText="No es nulo">
                <HeaderTemplate>
                    <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="Crear una caja nueva" Click="@HandleCreateBox" />
                </HeaderTemplate>
                <Columns>
                    <RadzenDataGridColumn Frozen="true" Property="@nameof(BoxDto.Id)" Title="ID" TextAlign="TextAlign.Center" />

                    <RadzenDataGridColumn Filterable="false" Property="@nameof(BoxDto.BoxCode)" Title="Código" />

                    <RadzenDataGridColumn Filterable="false" Property="@nameof(BoxDto.TotalProducts)" Title="Cant. productos" >
                        <Template Context="box">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                                <RadzenText>@box.TotalProducts</RadzenText>
                                @if (box.TotalProducts > 0)
                                {
                                    <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(() => ShowBoxProducts(box.Id, box.BoxCode))" />
                                }
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Property="@nameof(BoxDto.Location)" Title="Ubicación" />

                    <RadzenDataGridColumn Property="@nameof(BoxDto.CreatedAt)" Title="Creada el"/>

                    <RadzenDataGridColumn Property="@nameof(BoxDto.UpdatedAt)" Title="Última actualización"/>

                    <RadzenDataGridColumn Frozen="true" Sortable="false" TItem="BoxDto" Title="Acciones">
                        <Template Context="box">
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(() =>HandleEditBox(box.Id, box.BoxCode))" />
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Medium" Shade="Shade.Lighter" class="rz-my-1 rz-ms-1" Click="@(() => HandleDeleteBox(box.Id, box.BoxCode))" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenStack>
    </RadzenCard>
</PageLayoutSection>

@code {
    private RadzenDataGrid<BoxDto> grid = null!;
    private IEnumerable<BoxDto>? boxes;
    private IList<BoxDto>? selectedBoxes;
    private int count;
    private bool isLoading = false;
    private string GridMessage = "No hay cajas para mostrar.";
    private CancellationTokenSource? cts;

    private LogicalFilterOperator logicalFilterOperator = LogicalFilterOperator.Or;

    async Task LoadData(LoadDataArgs args)
    {
        if (isLoading) return;

        isLoading = true;

        cts?.Cancel();
        cts = new CancellationTokenSource();

        QueryItem query = new(args.Filter, args.OrderBy, args.Skip ?? 0, args.Top ?? 5);

        var result = await boxService.GetBoxesWithPaginationAsync(query, cts.Token);
        if (result.IsSuccess)
        {
            boxes = result.Value.Items;
            count = result.Value.Count;
            selectedBoxes = boxes.Take(1).ToList();
        }
        else
        {
            boxes = [];
            selectedBoxes = [];
            count = 0;
            GridMessage = result.Error.Description;
        }

        isLoading = false;
    }

    public async Task HandleEditBox(int boxId, string boxCode)
    {
        var result = await DialogService.OpenAsync<EditBoxForm>($"Editar caja código '{boxCode}'",
               new Dictionary<string, object>() { { "BoxId", boxId } },
               new DialogOptions()
               {
                   Width = "50%",
                   CloseDialogOnOverlayClick = true
               }
        );

        if (result is Result<bool> editResult)
        {
            if (editResult.IsSuccess)
            {
                SimpleNotifications.Success($"Caja '{boxCode}' editada con éxito.");
                await grid.Reload();
            }
            else
            {
                SimpleNotifications.Error($"Error: {editResult.Error.Description}");
            }
        }
    }

    private async Task HandleDeleteBox(int boxId, string boxCode)
    {
        var result = await DialogService.OpenAsync<DeleteBoxConfirmation>($"Confirmar eliminación",
        new Dictionary<string, object>() { { "BoxId", boxId }, { "BoxCode", boxCode } },
        new DialogOptions()
            {
                CloseDialogOnOverlayClick = true
            }
        );
        if (result is Result<bool> deleteResult)
        {
            if (deleteResult.IsSuccess)
            {
                SimpleNotifications.Success($"Caja '{boxCode}' eliminada con éxito.");
                await grid.Reload();
            }
            else
            {
                SimpleNotifications.Error($"Error: {deleteResult.Error.Description}");
            }
        }
    }

    private async Task HandleCreateBox()
    {
        var result = await DialogService.OpenAsync<CreateBoxForm>("Crear una nueva caja",
               new Dictionary<string, object>(),
               new DialogOptions()
               {
                   Width = "50%",
                   CloseDialogOnOverlayClick = true
               }
        );
        if (result is Result<bool> createResult)
        {
            if (createResult.IsSuccess)
            {
                SimpleNotifications.Success($"Caja creada con éxito!");
                await grid.Reload();
            }
            else
            {
                SimpleNotifications.Error($"Error: {createResult.Error.Description}");
            }
        }
    }

    public async Task ShowBoxProducts(int boxId, string boxCode)
    {
        await DialogService.OpenAsync<BoxProducts>($"Productos en la caja código '{boxCode}'",
               new Dictionary<string, object>() { { "BoxId", boxId } },
               new DialogOptions()
               {
                   Width = "75%",
                   Height = "65%",
                   CloseDialogOnOverlayClick = true
               }
        );

    }

    async Task ResetAsync()
    {
        cts?.Cancel();

        grid.Reset(true);
        await grid.FirstPage(true);
    }
}
