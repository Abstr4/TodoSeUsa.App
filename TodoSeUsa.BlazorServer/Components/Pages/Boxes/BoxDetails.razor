@page "/cajas/{Id:int}"

@using TodoSeUsa.Application.Common
@using TodoSeUsa.Application.Common.Models
@using TodoSeUsa.Application.Features.Boxes.DTOs
@using TodoSeUsa.Application.Features.Boxes.Interfaces
@using TodoSeUsa.Application.Features.Products.DTOs
@using TodoSeUsa.Application.Features.Products.Interfaces
@using TodoSeUsa.BlazorServer.Helpers
@using TodoSeUsa.Domain.Enums

@inject IBoxService BoxService
@inject IProductService ProductService
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject SimpleNotifications SimpleNotifications


<style>
    .rz-fieldset-toggler {
        font-weight: 800;
        width: 25px;
        height: 25px;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid;
        border-radius: 25%;
    }

    table h6, .subtitle1 {
        margin: 0 !important;
    }
</style>

@if (isLoading)
{
    <RadzenCard Style="padding:2rem;">
        <RadzenStack Gap="1rem" Style="width:100%" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
            <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" AriaLabel="Primary loading" />
        </RadzenStack>
    </RadzenCard>
}
else if (originalBox is null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
        @errorMessage
    </RadzenAlert>
    <RadzenButton Icon="arrow_back" Text="Volver" Click="@GoBack" />

}
else
{
    <PageLayoutSection Title="@($"Detalles de caja '{originalBox.BoxCode}'")">
        <RadzenCard Style="padding:2rem; width: 100%">
            <RadzenStack Gap="1rem">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Right" Wrap="FlexWrap.Wrap">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Icon="edit" Text="Editar" ButtonStyle="ButtonStyle.Warning"
                                      Click=@HandleEditBox />
                        <RadzenButton Icon="delete" Text="Borrar" ButtonStyle="ButtonStyle.Danger"
                                      Click=@HandleDeleteBox />
                    </RadzenStack>
                </RadzenStack>

                <RadzenTable Style="border:1px solid #ddd; border-radius:8px; width:100%; margin-top:1rem;">
                    <RadzenTableHeader>
                        <RadzenTableHeaderRow>
                            <RadzenTableHeaderCell style="width: 40%; font-weight:bold;">
                                <RadzenText TextStyle="TextStyle.H6" Text="Propiedad" />
                            </RadzenTableHeaderCell>
                            <RadzenTableHeaderCell style="width: 60%; font-weight:bold;">
                                <RadzenText TextStyle="TextStyle.H6" Text="Valor" />
                            </RadzenTableHeaderCell>
                        </RadzenTableHeaderRow>
                    </RadzenTableHeader>

                    <RadzenTableBody>
                        <RadzenTableRow>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="ID" style="font-weight:bold" />
                            </RadzenTableCell>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="@originalBox.Id.ToString()" />
                            </RadzenTableCell>
                        </RadzenTableRow>

                        <RadzenTableRow>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="Código" style="font-weight:bold;" />
                            </RadzenTableCell>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="@originalBox.BoxCode" />
                            </RadzenTableCell>
                        </RadzenTableRow>

                        <RadzenTableRow>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="Ubicación" style="font-weight:bold;" />
                            </RadzenTableCell>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="@originalBox.Location" />
                            </RadzenTableCell>
                        </RadzenTableRow>

                        <RadzenTableRow>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="Productos totales" style="font-weight:bold;" />
                            </RadzenTableCell>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="@originalBox.TotalProducts.ToString()" />
                            </RadzenTableCell>
                        </RadzenTableRow>

                        <RadzenTableRow>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="Creado" style="font-weight:bold;" />
                            </RadzenTableCell>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="@originalBox.CreatedAt.ToString("dd/MM/yyyy HH:mm")" />
                            </RadzenTableCell>
                        </RadzenTableRow>

                        <RadzenTableRow>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="Actualizado" style="font-weight:bold;" />
                            </RadzenTableCell>
                            <RadzenTableCell>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="@originalBox.UpdatedAt.ToString("dd/MM/yyyy HH:mm")" />
                            </RadzenTableCell>
                        </RadzenTableRow>
                    </RadzenTableBody>
                </RadzenTable>

                @if (originalBox.TotalProducts == 0)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                        Ésta caja no contiene productos.
                    </RadzenAlert>
                }
                else
                {
                    <RadzenFieldset AllowCollapse="true" Collapsed="true" class="w-100 rz-mt-4">
                        <HeaderTemplate>
                            <RadzenText TextStyle="TextStyle.H6" class="rz-display-flex rz-align-items-center rz-m-0">
                                <RadzenIcon Style="font-size: 20px" Icon="account_box" class="rz-me-1" /><b>Productos en la caja</b>
                            </RadzenText>
                        </HeaderTemplate>
                        <ChildContent>
                            <RadzenCard Variant="Variant.Outlined">
                                <FilterControls LogicalFilterValue="@logicalFilterOperator" LogicalFilterValueChanged="@(v => logicalFilterOperator = v)" LogicalFilterOnChanged="@(async () => await grid.Reload())" ResetButtonClicked="@ResetProductsGridAsync" />
                            </RadzenCard>
                            <RadzenDataGrid @ref=@grid TItem="ProductDto" Data=@products
                                            Count=@productsCount
                                            IsLoading=@isLoadingProducts
                                            LoadData=@LoadProducts
                                            PageSize="5"
                                            AllowPaging="true" AllowSorting="true"
                                            AllowFiltering="true" ShowPagingSummary="true"
                                            AllowColumnResize="true"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                            FilterMode="FilterMode.Simple"
                                            PagerHorizontalAlign="HorizontalAlign.Left"
                                            ColumnWidth="200px"
                                            class="rz-mt-4"
                                            ClearFilterText="Limpiar"
                                            ApplyFilterText="Aplicar"
                                            FilterText="Filtro"
                                            ContainsText="Contiene"
                                            EqualsText="Equivale"
                                            AndOperatorText="Y"
                                            OrOperatorText="O"
                                            LessThanOrEqualsText="Menor o igual que"
                                            LessThanText="Menor que"
                                            GreaterThanOrEqualsText="Mayor o igual que"
                                            GreaterThanText="Mayor que"
                                            NotEqualsText="No es igual a"
                                            IsNullText="Es nulo"
                                            IsNotNullText="No es nulo">
                                <Columns>
                                    <RadzenDataGridColumn Filterable="false" Property="Id" Title="ID" Width="80px" MinWidth="80px" />
                                    <RadzenDataGridColumn Property="Category" Title="Categoría" MinWidth="200px" />
                                    <RadzenDataGridColumn Property="Description" Title="Descripción" MinWidth="200px" />
                                    <RadzenDataGridColumn Property="Price" Title="Precio" MinWidth="200px" />
                                    <RadzenDataGridColumn Property="Status" Title="Estado" FilterValue="@selectedStatus">
                                        <Template Context="s">
                                            @TranslateStatus(s.Status)
                                        </Template>
                                        <FilterTemplate>
                                            <RadzenDropDown @bind-Value="@selectedStatus"
                                                            Placeholder="Seleccionar..."
                                                            Data="@statuses"
                                                            TextProperty="Text"
                                                            ValueProperty="Value"
                                                            AllowClear="true"
                                                            Style="width:100%;">
                                            </RadzenDropDown>
                                        </FilterTemplate>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn Property="Quality" Title="Calidad" FilterValue="@selectedQuality">
                                        <Template Context="p">
                                            @TranslateQuality(p.Quality)
                                        </Template>
                                        <FilterTemplate>
                                            <RadzenDropDown @bind-Value="@selectedQuality"
                                                            Placeholder="Seleccionar..."
                                                            Data="@qualities"
                                                            TextProperty="Text"
                                                            ValueProperty="Value"
                                                            AllowClear="true"
                                                            Style="width:100%;">
                                            </RadzenDropDown>
                                        </FilterTemplate>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn Property="Season" Title="Temporada" FilterValue="@selectedSeason">
                                        <Template Context="s">
                                            @TranslateSeason(s.Season)
                                        </Template>
                                        <FilterTemplate>
                                            <RadzenDropDown @bind-Value="@selectedSeason"
                                                            Placeholder="Seleccionar..."
                                                            Data="@seasons"
                                                            TextProperty="Text"
                                                            ValueProperty="Value"
                                                            AllowClear="true"
                                                            Style="width:100%;">
                                            </RadzenDropDown>
                                        </FilterTemplate>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn Property="CreatedAt" Title="Creado" FormatString="{0:dd/MM/yyyy HH:mm}" MinWidth="120px" />
                                    <RadzenDataGridColumn Property="RefurbishmentCost" Title="Costo reacondicionamiento" MinWidth="120px" />
                                    <RadzenDataGridColumn Property="SaleId" Title="Id de la venta" MinWidth="120px" />
                                    <RadzenDataGridColumn Property="UpdatedAt" Title="Actualizado" FormatString="{0:dd/MM/yyyy HH:mm}" MinWidth="120px" />
                                </Columns>
                            </RadzenDataGrid>
                        </ChildContent>
                        <SummaryTemplate>
                            <RadzenCard Variant="Variant.Outlined" class="rz-mt-4">
                                <b>@originalBox.TotalProducts Productos</b>
                            </RadzenCard>
                        </SummaryTemplate>
                    </RadzenFieldset>
                }
            </RadzenStack>
        </RadzenCard>
    </PageLayoutSection>
}



@code {
    [Parameter] public int Id { get; set; }

    private RadzenDataGrid<ProductDto> grid = null!;
    BoxDto? originalBox;
    private EditBoxDto editBox = new();
    IEnumerable<ProductDto>? products;
    int productsCount;
    string? errorMessage;
    bool isLoadingProducts = false;
    bool isLoading = true;
    private LogicalFilterOperator logicalFilterOperator = LogicalFilterOperator.Or;

    private ProductQuality? selectedQuality = null;
    private Season? selectedSeason = null;
    private ProductStatus? selectedStatus = null;

    private IEnumerable<FilterOption<ProductQuality?>> qualities =
    new[] { new FilterOption<ProductQuality?> { Value = null, Text = "Todas" } }
        .Concat(Enum.GetValues(typeof(ProductQuality))
        .Cast<ProductQuality>()
        .Select(q => new FilterOption<ProductQuality?>
        {
            Value = q,
            Text = TranslateQuality(q)
        }))
        .ToList();

    private IEnumerable<FilterOption<ProductStatus?>> statuses =
    new[] { new FilterOption<ProductStatus?> { Value = null, Text = "Todos" } }
        .Concat(Enum.GetValues(typeof(ProductStatus))
        .Cast<ProductStatus>()
        .Select(s => new FilterOption<ProductStatus?>
        {
            Value = s,
            Text = TranslateStatus(s)
        }))
        .ToList();

    private IEnumerable<FilterOption<Season?>> seasons =
    new[] { new FilterOption<Season?> { Value = null, Text = "Todas" } }
        .Concat(Enum.GetValues(typeof(Season))
        .Cast<Season>()
        .Select(s => new FilterOption<Season?>
        {
            Value = s,
            Text = TranslateSeason(s)
        }))
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        var result = await BoxService.GetByIdAsync(Id, CancellationToken.None);
        if (result.IsSuccess)
        {
            originalBox = result.Value;
        }
        else
        {
            errorMessage = result.Error.ToString();
        }
        isLoading = false;
    }

    private async Task LoadProducts(LoadDataArgs args)
    {
        if (isLoadingProducts) return;
        try
        {
            isLoadingProducts = true;

            QueryRequest request = QueryRequestHelper.ConvertToQueryRequest(args, logicalFilterOperator);

            var result = await ProductService.GetByBoxIdAsync(request, Id, CancellationToken.None);

            if (result.IsSuccess)
            {
                products = result.Value.Items;
                productsCount = result.Value.Count;
            }
            else
            {
                products = [];
                productsCount = 0;
            }
        }
        finally
        {
            isLoadingProducts = false;
        }
    }

    private async Task HandleEditBox()
    {
        if (originalBox is null) return;

        var result = await DialogService.OpenAsync<EditBoxForm>($"Editar caja código '{originalBox.BoxCode}'",
               new Dictionary<string, object>() { { "BoxId", originalBox.Id } },
               new DialogOptions()
               {
                   Width = "50%",
                   CloseDialogOnOverlayClick = true
               }
        );

        if (result is Result<bool> editResult)
        {
            if (editResult.IsSuccess)
            {
                SimpleNotifications.Success($"Caja '{originalBox.BoxCode}' editada con éxito.");

                var refreshed = await BoxService.GetByIdAsync(originalBox.Id, CancellationToken.None);
                if (refreshed.IsSuccess)
                {
                    originalBox = refreshed.Value;
                }
                StateHasChanged();
            }
            else
            {
                SimpleNotifications.Error($"Error: {editResult.Error.Description}");
            }
        }
    }

    private async Task HandleDeleteBox()
    {
        if (originalBox is null) return;

        var result = await DialogService.OpenAsync<DeleteBoxConfirmation>($"Confirmar eliminación",
        new Dictionary<string, object>() { { "BoxId", Id }, { "BoxCode", originalBox.BoxCode } },
        new DialogOptions()
        {
            CloseDialogOnOverlayClick = true
        }
        );
        if (result is Result<bool> deleteResult)
        {
            if (deleteResult.IsSuccess)
            {
                SimpleNotifications.Success($"Caja '{originalBox.BoxCode}' eliminada con éxito.");
                GoBack();
            }
            else
            {
                SimpleNotifications.Error($"Error: {deleteResult.Error.Description}");
            }
        }
    }

    private async Task ResetProductsGridAsync()
    {
        selectedQuality = null;
        selectedSeason = null;
        selectedStatus = null;

        grid.Reset();

        var args = new LoadDataArgs
        {
            Skip = 0,
            Top = grid.PageSize
        };

        await LoadProducts(args);
    }

    private static string TranslateQuality(ProductQuality quality) => quality switch
    {
        ProductQuality.Poor => "Mala",
        ProductQuality.Fair => "Aceptable",
        ProductQuality.Good => "Buena",
        ProductQuality.LikeNew => "Como nueva",
        ProductQuality.New => "Nueva",
        _ => quality.ToString()
    };

    private static string TranslateStatus(ProductStatus status) => status switch
    {
        ProductStatus.Available => "Disponible",
        ProductStatus.Sold => "Vendido",
        ProductStatus.Loaned => "Prestado",
        ProductStatus.Reserved => "Reservado",
        ProductStatus.Discontinued => "Descontinuado",
        _ => status.ToString()
    };

    private static string TranslateSeason(Season? season)
    {
        if (season is null)
            return "";

        return season switch
        {
            Season.Spring => "Primavera",
            Season.Summer => "Verano",
            Season.Autumn => "Otoño",
            Season.Winter => "Invierno",
            _ => season.ToString()!
        };
    }

    private void GoBack() => NavigationManager.NavigateTo("/cajas");
}
