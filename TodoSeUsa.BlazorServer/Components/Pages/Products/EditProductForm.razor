@using System.Text.Json
@using TodoSeUsa.Application.Features.Products.DTOs
@using TodoSeUsa.Application.Features.Products.Interfaces
@using TodoSeUsa.BlazorServer.Helpers
@using TodoSeUsa.Domain.Enums

@inject Radzen.DialogService DialogService;
@inject IProductService ProductService;
@inject SimpleNotifications SimpleNotifications;


<RadzenTemplateForm TItem="EditProductDto" Data=@editProductDto Submit=@OnSubmit>
    <RadzenStack Gap="1rem">
        <RadzenFieldset Text="Info. del producto">
            <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
                <RadzenRow>
                    <RadzenColumn Size="12" SizeSM="6">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" id="price-stack">
                            <RadzenLabel Component="Category">
                                Precio <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenNumeric Name="Price" @bind-Value=@editProductDto.Price Style="width: 100%;" TValue="decimal" Change="@OnPriceChanged" />
                            <RadzenRequiredValidator Component="Price" Text="- El precio es requerido." />
                            <RadzenNumericRangeValidator Component="Price" Min="1" Text="El precio debe ser mayor a cero."></RadzenNumericRangeValidator>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" id="quality-stack">
                            <RadzenLabel Component="Quality">
                                Calidad <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenDropDown @bind-Value="@editProductDto.Quality"
                                            Placeholder="Seleccionar calidad..."
                                            Data="@qualities"
                                            TextProperty="Text"
                                            ValueProperty="Value"
                                            Style="width:100%;"
                                            TValue="ProductQuality"
                                            Change="@OnQualityChanged"
                                            Name="Quality">
                            </RadzenDropDown>
                            <RadzenRequiredValidator Component="Quality" Text="- La calidad es requerida." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" id="category-stack">
                            <RadzenLabel Component="Category">
                                Categoría <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenTextBox Name="Category" @bind-Value=@editProductDto.Category Style="width: 100%;" Change="@OnCategoryChanged" Placeholder="Categoría..." />
                            <RadzenRequiredValidator Component="Category" Text="- La categoría es requerida." />
                            <RadzenRegexValidator Component="Category"
                                                  Pattern="^(?=.*[\p{L}\p{N}]).{1,100}$"
                                                  Text="- La categoría debe tener entre 1 y 100 caracteres válidos (no solo espacios o símbolos).">
                            </RadzenRegexValidator>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" id="consignmentId-stack">
                            <RadzenLabel Component="ConsignmentId">
                                Id de la consignación<RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenNumeric Name="ConsignmentId" @bind-Value=@editProductDto.ConsignmentId Style="width: 100%;" TValue="int" Change="@OnConsignmentIdChanged" />
                            <RadzenRequiredValidator Component="ConsignmentId" Text="El Id de la consignación es obligatorio."></RadzenRequiredValidator>
                            <RadzenNumericRangeValidator Component="ConsignmentId" Min="1" Text="El Id de la consignación debe ser mayor a cero."></RadzenNumericRangeValidator>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" id="description-stack">
                    <RadzenLabel Component="Description">
                        Descripción <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                    </RadzenLabel>
                    <RadzenTextBox Name="Description" @bind-Value=@editProductDto.Description Style="width: 100%;" Change="@OnDescriptionChanged" Placeholder="Descripción..." />
                    <RadzenRequiredValidator Component="Description" Text="- La descripción es requerida." />
                    <RadzenRegexValidator Component="Description"
                                          Pattern="^(?=.*[\p{L}\p{N}]).{1,250}$"
                                          Text="- La descripción debe tener entre 1 y 250 caracteres válidos (no solo espacios o símbolos).">
                    </RadzenRegexValidator>
                </RadzenStack>
                <RadzenRow>
                    <RadzenColumn Size="12" SizeSM="6">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" id="season-stack">
                            <RadzenLabel Component="Season">
                                Temporada <RadzenBadge BadgeStyle="BadgeStyle.Info" Variant="Variant.Outlined" Text="Opcional" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenDropDown @bind-Value="@editProductDto.Season"
                                            Placeholder="Sin temporada asignada..."
                                            Data="@seasons"
                                            TextProperty="Text"
                                            ValueProperty="Value"
                                            Style="width:100%;">
                            </RadzenDropDown>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" id="refurbishmentCost-stack">
                            <RadzenLabel Component="RefurbishmentCost">
                                Costo del reacondicionamiento<RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenNumeric Name="RefurbishmentCost" @bind-Value=@editProductDto.RefurbishmentCost Style="width: 100%;" Placeholder="Sin costo asignado..." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" id="boxId-stack">
                            <RadzenLabel Component="BoxId">
                                Id de la caja<RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenNumeric Name="BoxId" @bind-Value=@editProductDto.BoxId Style="width: 100%;" Placeholder="Sin caja asignada..." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6">
                        <RadzenStack Style="height: 100%" Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" JustifyContent="JustifyContent.End">
                            <RadzenButton Click="@ResetToOriginal">
                                <RadzenIcon Icon="reset_settings"></RadzenIcon>
                            </RadzenButton>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenFieldset>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" class="rz-mt-8">
            <RadzenButton IsBusy=@busy BusyText="Guardando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Guardar" Disabled=@IsSaveDisabled />
            <RadzenButton Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Base" Icon="cancel" Text="Cancelar" Click="@(() => DialogService.Close())" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>


@code {

    [Parameter] public int ProductId { get; set; }

    private ProductDto originalProduct = new();
    private EditProductDto editProductDto = new();

    private bool busy;

    private bool IsPriceValid => editProductDto.Price > 0;
    private bool IsCategoryValid => !string.IsNullOrWhiteSpace(editProductDto.Category);
    private bool IsQualityValid => Enum.IsDefined(typeof(ProductQuality), editProductDto.Quality);
    private bool IsConsignmentValid => editProductDto.ConsignmentId > 0;
    private bool IsDescriptionValid => !string.IsNullOrWhiteSpace(editProductDto.Description);
    private bool IsSeasonValid => editProductDto.Season == null || Enum.IsDefined(typeof(Season), editProductDto.Season);
    private bool IsRefurbishmentCostValid => editProductDto.RefurbishmentCost == null || editProductDto.RefurbishmentCost > 0;
    private bool IsBoxIdValid => editProductDto.BoxId == null || editProductDto.BoxId > 0;

    private bool IsSaveDisabled => !(IsPriceValid && IsCategoryValid && IsQualityValid &&
                                 IsConsignmentValid && IsDescriptionValid &&
                                 IsSeasonValid && IsRefurbishmentCostValid && IsBoxIdValid) || !HasChanges();

    protected override async Task OnInitializedAsync()
    {
        var result = await ProductService.GetByIdAsync(ProductId, CancellationToken.None);
        if (result.IsSuccess)
        {
            originalProduct = result.Value;

            editProductDto = new EditProductDto
            {
                Price = originalProduct.Price,
                Description = originalProduct.Description,
                Category = originalProduct.Category,
                Quality = originalProduct.Quality,
                Status = originalProduct.Status,
                Season = originalProduct.Season,
                RefurbishmentCost = originalProduct.RefurbishmentCost,
                ConsignmentId = originalProduct.ConsignmentId,
                SaleId = originalProduct.SaleId,
                BoxId = originalProduct.BoxId
            };
        }
        else
        {
            DialogService.Close();
            SimpleNotifications.Error(result.Error.ToString());
        }
    }

    async Task OnSubmit(EditProductDto editProductDto)
    {
        busy = true;
        var result = await ProductService.EditProductById(ProductId, editProductDto, CancellationToken.None);
        busy = false;
        await Task.Delay(1000);
        DialogService.Close(result);
    }

    private IEnumerable<FilterOption<ProductQuality?>> qualities =
        Enum.GetValues(typeof(ProductQuality))
        .Cast<ProductQuality>()
        .Select(q => new FilterOption<ProductQuality?>
        {
            Value = q,
            Text = EnumTranslate.TranslateQuality(q)
        })
        .ToList();

    private IEnumerable<FilterOption<Season?>> seasons =
        Enum.GetValues(typeof(Season))
        .Cast<Season>()
        .Select(s => new FilterOption<Season?>
        {
            Value = s,
            Text = EnumTranslate.TranslateSeason(s)
        })
        .ToList();


    private void OnPriceChanged(decimal value)
    {
        editProductDto.Price = value;
        StateHasChanged();
    }

    private void OnCategoryChanged(string value)
    {
        editProductDto.Category = value;
        StateHasChanged();
    }

    private void OnQualityChanged(object value)
    {
        editProductDto.Quality = (ProductQuality)value;
        StateHasChanged();
    }

    private void OnConsignmentIdChanged(int value)
    {
        editProductDto.ConsignmentId = value;
        StateHasChanged();
    }

    private void OnDescriptionChanged(string value)
    {
        editProductDto.Description = value;
        StateHasChanged();
    }

    private void OnRefurbishmentCostChanged(decimal? value)
    {
        editProductDto.RefurbishmentCost = value;
        StateHasChanged();
    }

    private void OnSeasonChanged(object? value)
    {
        editProductDto.Season = (Season?)value;
        StateHasChanged();
    }

    private void OnBoxIdChanged(int? value)
    {
        editProductDto.BoxId = value;
        StateHasChanged();
    }

    private void ClearBoxId()
    {
        editProductDto.BoxId = null;
        OnBoxIdChanged(null);
        StateHasChanged();
    }

    private void ClearRefurbishmentCost()
    {
        editProductDto.RefurbishmentCost = null;
        OnRefurbishmentCostChanged(null);
        StateHasChanged();
    }

    private void ClearSeason()
    {
        editProductDto.Season = null;
        OnSeasonChanged(null);
        StateHasChanged();
    }

    private void ResetToOriginal()
    {
        editProductDto = new EditProductDto
        {
            Price = originalProduct.Price,
            Description = originalProduct.Description,
            Category = originalProduct.Category,
            Quality = originalProduct.Quality,
            Status = originalProduct.Status,
            Season = originalProduct.Season,
            RefurbishmentCost = originalProduct.RefurbishmentCost,
            ConsignmentId = originalProduct.ConsignmentId,
            SaleId = originalProduct.SaleId,
            BoxId = originalProduct.BoxId
        };
        StateHasChanged();
    }

    private bool HasChanges()
    {
        return editProductDto.Price != originalProduct.Price
            || editProductDto.Category != originalProduct.Category
            || editProductDto.Quality != originalProduct.Quality
            || editProductDto.ConsignmentId != originalProduct.ConsignmentId
            || editProductDto.Description != originalProduct.Description
            || editProductDto.Season != originalProduct.Season
            || editProductDto.RefurbishmentCost != originalProduct.RefurbishmentCost
            || editProductDto.BoxId != originalProduct.BoxId;
    }
}
