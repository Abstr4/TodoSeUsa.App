@page "/productos/registrar"

@using TodoSeUsa.Application.Features.Products.DTOs
@using TodoSeUsa.Application.Features.Products.Interfaces
@using TodoSeUsa.BlazorServer.Enums
@using TodoSeUsa.BlazorServer.UI.RadzenAdapters.Files
@using TodoSeUsa.BlazorServer.Validation

@inject IProductService ProductService;

@inject IJSRuntime JS;
@inject NavigationManager NavigationManager;
@inject SimpleNotifications SimpleNotifications;

@attribute [Authorize]

<RadzenCard Style="max-width: 100%; min-height: 100%">

    <PageTitleWithBackButton Title="Registrar producto" />

    <RadzenStack>

    </RadzenStack>

    <RadzenTemplateForm TItem="CreateProductDto" Data=@createProductDto Submit=@OnSubmit>

        <RadzenFieldset Text="Información del producto" >

            <RadzenStack class="rz-mb-6" Orientation="Orientation.Vertical" Gap="1rem">

                <RadzenRow Gap="1rem">

                    <RadzenColumn Size="12" SizeMD="8" SizeLG="9" id="fields-column">

                        <RadzenRow>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="price-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" >

                                    <RadzenLabel Component="Price">
                                        Precio <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenNumeric Name="Price" @bind-Value=@createProductDto.Price Style="width: 100%;" TValue="decimal" Min="0" />

                                    <RadzenRequiredValidator Component="Price" Text="El precio es requerido." />
                                    <RadzenNumericRangeValidator Component="Price" Min="1" Text="El precio debe ser mayor a cero." />
                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="quantity-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                    <RadzenLabel Component="Quantity">
                                        Cantidad <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenNumeric Name="Quantity" @bind-Value="@createProductDto.Quantity" Min="1" />

                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="consignmentId-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" >

                                    <RadzenLabel Component="ConsignmentId">
                                        Id de la consignación<RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Req." Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenNumeric Name="ConsignmentId" @bind-Value=@createProductDto.ConsignmentId Style="width: 100%;" TValue="int" Min="1" Disabled="@(ConsignmentId != null)" />

                                    <RadzenRequiredValidator Component="ConsignmentId" Text="El Id de la consignación es obligatorio." />

                                    <RadzenNumericRangeValidator Component="ConsignmentId" Min="1" Text="El Id de la consignación debe ser mayor a cero." />
                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="size-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" >

                                    <RadzenLabel Component="Size">
                                        Talle<RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenTextBox Name="Size" @bind-Value=@createProductDto.Size Style="width: 100%;" TValue="int" Min="1" />

                                    <RadzenRequiredValidator Component="Size" Text="El talle es obligatorio."></RadzenRequiredValidator>

                                    <RadzenRegexValidator Component="Size"
                                                            Pattern="^(?=.*[\p{L}\p{N}]).{1,50}$"
                                                            Text="El talle debe tener entre 1 y 50 caracteres válidos (no solo espacios o símbolos)." />
                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="body-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                    <RadzenLabel Component="Body">
                                        Cuerpo <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenDropDown @bind-Value="@createProductDto.Body"
                                                    Placeholder="Seleccionar cuerpo..."
                                                    Data="@EnumOptionLists.bodies"
                                                    TextProperty="Text"
                                                    ValueProperty="Value"
                                                    Style="width:100%;"
                                                    Name="Body">
                                    </RadzenDropDown>

                                    <RadzenRequiredValidator Component="Body" Text="La calidad es requerida." />
                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="quality-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" >

                                    <RadzenLabel Component="Quality">
                                        Calidad <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenDropDown @bind-Value="@createProductDto.Quality"
                                                    Placeholder="Seleccionar calidad..."
                                                    Data="@EnumOptionLists.qualities"
                                                    TextProperty="Text"
                                                    ValueProperty="Value"
                                                    Style="width:100%;"
                                                    Name="Quality">
                                    </RadzenDropDown>

                                    <RadzenRequiredValidator Component="Quality" Text="La calidad es requerida." />
                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="category-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" >

                                    <RadzenLabel Component="Category">
                                        Categoría <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenTextBox Name="Category" @bind-Value=@createProductDto.Category Style="width: 100%;" Placeholder="Categoría..." />

                                    <RadzenRequiredValidator Component="Category" Text="La categoría es requerida." />

                                    <RadzenRegexValidator Component="Category"
                                                            Pattern="^(?=.*[\p{L}\p{N}]).{1,100}$"
                                                            Text="La categoría debe tener entre 1 y 100 caracteres válidos (no solo espacios o símbolos)." />
                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="description-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" >

                                    <RadzenLabel Component="Description">
                                        Descripción <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenTextArea Cols="30" Rows="3" Name="Description" @bind-Value=@createProductDto.Description Style="width: 100%;" Placeholder="Descripción..." />

                                    <RadzenRequiredValidator Component="Description" Text="La descripción es requerida." />

                                    <RadzenRegexValidator Component="Description"
                                                            Pattern="^(?=.*[\p{L}\p{N}]).{1,250}$"
                                                            Text="La descripción debe tener entre 1 y 250 caracteres válidos (no solo espacios o símbolos)." />
                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="season-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                    <RadzenLabel Component="Season">
                                        Temporada <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenTextBox MaxLength="250" Name="Season" @bind-Value=@createProductDto.Season Style="width: 100%;" Change="@OnSeasonChanged" Placeholder="Temporada..." />

                                    <RadzenCustomValidator Component="Season"
                                                           Validator="(() => InputValidators.IsNullOrEmptyOrMatchesAlphanumericPattern(createProductDto.Season))"
                                                           Text="La temporada no puede contener solo espacios o símbolos." />

                                    <RadzenLengthValidator Component="Season" Max="250" Text="La temporada debe tener entre 1 y 250 carácteres." />

                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="boxId-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                    <RadzenLabel Component="BoxId">
                                        Código de la caja<RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <div style="position: relative; display: flex; align-items: center;">
                                        <RadzenNumeric @bind-Value="@createProductDto.BoxId"
                                                       Name="BoxId"
                                                       Min="1"
                                                       Style="width: 100%;"
                                                       Placeholder="Sin caja asignada..." />

                                        @if (createProductDto.BoxId != null)
                                        {
                                            <i class="notranslate rzi rz-cell-filter-clear"
                                               style="position:absolute; inset-inline-end:15px; cursor:pointer;"
                                               @onclick="ClearBoxId"
                                               onmouseover="this.style.backgroundColor='rgba(0,0,0,0.1)'"
                                               onmouseout="this.style.backgroundColor='transparent'">close</i>
                                        }
                                    </div>
                                </RadzenStack>

                                <RadzenCustomValidator Component="BoxId"
                                                       Text="El código debe ser mayor que cero.."
                                                       Validator="@(() => createProductDto.BoxId is null || createProductDto.BoxId > 0)" />

                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeSM="6" SizeLG="4" id="refurbishmentCost-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                    <RadzenLabel Component="RefurbishmentCost">
                                        Costo del arreglo<RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <div style="position: relative; display: flex; align-items: center;">

                                        <RadzenNumeric @bind-Value="@createProductDto.RefurbishmentCost"
                                                       Name="RefurbishmentCost"
                                                       Style="width: 100%;"
                                                       Min="1"
                                                       Placeholder="Sin costo asignado..."
                                                       TValue="decimal?" />

                                        @if (createProductDto.RefurbishmentCost.HasValue)
                                        {
                                            <i class="notranslate rzi rz-cell-filter-clear"
                                               style="position:absolute; inset-inline-end:15px; cursor:pointer;"
                                               @onclick="ClearRefurbishmentCost"
                                               onmouseover="this.style.backgroundColor='rgba(0,0,0,0.1)'"
                                               onmouseout="this.style.backgroundColor='transparent'">close</i>
                                        }
                                    </div>

                                    <RadzenNumericRangeValidator Component="RefurbishmentCost" Min="1" Text="El costo del arreglo debe ser mayor a cero" Visible="@createProductDto.RefurbishmentCost.HasValue" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                    </RadzenColumn>
                </RadzenRow>

            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="1rem" >

                <RadzenButton IsBusy="@isSaveButtonBusy" BusyText="Creando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Crear" />

            </RadzenStack>

        </RadzenFieldset>

    </RadzenTemplateForm>

</RadzenCard>

@code
{
    [Parameter] public int? ConsignmentId { get; set; }
    [Parameter] public int? SaleId { get; set; }

    private bool isSaveButtonBusy = false;
    private CreateProductDto createProductDto = new();

    protected override void OnInitialized()
    {
        createProductDto = new CreateProductDto
        {
            Price = 0,
            Body = Body.Unisex,
            Quality = ProductQuality.New,
            ConsignmentId = ConsignmentId ?? 0
        };
    }

    private async Task OnSubmit(CreateProductDto createProductDto)
    {
        isSaveButtonBusy = true;

        bool createResult;
        IReadOnlyList<int> createdIds = Array.Empty<int>();

        if (createProductDto.Quantity == 1)
        {
            var result = await ProductService.CreateAsync(createProductDto, CancellationToken.None);

            createResult = result.IsSuccess;

            if (createResult)
                createdIds = new List<int> { result.Value };
        }

        else
        {
            var result = await ProductService.CreateBatchAsync(createProductDto, CancellationToken.None);

            createResult = result.IsSuccess;

            if (createResult)
                createdIds = result.Value;
        }

        isSaveButtonBusy = false;

        if (createResult)
        {
            NavigationManager.NavigateTo("/productos");
            SimpleNotifications.Success("Producto(s) creado(s) exitosamente.");
            return;
        }

    }

    private void ClearBoxId()
    {
        createProductDto.BoxId = null;
        StateHasChanged();
    }

    private void ClearRefurbishmentCost()
    {
        createProductDto.RefurbishmentCost = null;
        StateHasChanged();
    }

    private void OnSeasonChanged(string? value)
    {
        createProductDto.Season = value == "" ? null : value;
        StateHasChanged();
    }

    private void OnBoxIdChanged(int? value)
    {
        createProductDto.BoxId = value == 0 ? null : value;
        StateHasChanged();
    }
}

