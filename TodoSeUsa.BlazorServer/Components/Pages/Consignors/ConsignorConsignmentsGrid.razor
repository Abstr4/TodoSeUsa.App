@using TodoSeUsa.Application.Features.Consignments.DTOs
@using TodoSeUsa.Application.Features.Consignments.Interfaces
@using TodoSeUsa.Application.Features.Products.DTOs
@using TodoSeUsa.Application.Features.Products.Interfaces
@using TodoSeUsa.Application.Features.Consignors.DTOs
@using TodoSeUsa.BlazorServer.Components.Pages.Consignments
@using TodoSeUsa.BlazorServer.Components.Pages.Products


@inject IConsignmentService ConsignmentService;

@inject DialogService DialogService;
@inject NavigationManager NavigationManager;
@inject SimpleNotifications SimpleNotifications;

<RadzenDataGrid @ref="grid" IsLoading="@isLoading" TItem="ConsignmentDto" Data="@consignments"
                LoadData="@LoadConsignments"
                Count="@count" EmptyText="@GridMessage" LogicalFilterOperator="@logicalFilterOperator"
                SelectionMode="DataGridSelectionMode.Single" PageSize="5"
                AllowSorting="true" AllowFiltering="true" AllowPaging="true" AllowColumnResize=true
                FilterMode="FilterMode.Simple" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                GridLines="DataGridGridLines.Both" PagerHorizontalAlign="HorizontalAlign.Center"
                ClearFilterText="Limpiar" ApplyFilterText="Aplicar" FilterText="Filtro"
                ContainsText="Contiene" EqualsText="Equivale" AndOperatorText="Y"
                OrOperatorText="O" LessThanOrEqualsText="Menor o igual que" LessThanText="Menor que"
                GreaterThanOrEqualsText="Mayor o igual que" GreaterThanText="Mayor que" NotEqualsText="No es igual a"
                IsNullText="Es nulo" IsNotNullText="No es nulo" ColumnWidth="200px">

    <Columns>

        <RadzenDataGridColumn Filterable="false" Sortable="false" TItem="ConsignmentDto" Title="Ver" MinWidth="80px" Width="80px">
            <Template Context="consignment">

                <RadzenButton Icon="read_more" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(() => ViewConsignment(consignment.Id))" />

            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="Code" Title="Código" TextAlign="TextAlign.Center" MinWidth="120px" Width="200px" />

        <RadzenDataGridColumn Filterable="false" Property="TotalProducts" Title="Cant. productos" MinWidth="80px" Width="140px" />

        <RadzenDataGridColumn Property="DateIssued" Title="Emitida el" FormatString="{0:dd/MM/yyyy HH:mm}" MinWidth="120px" Width="160px" />

        <RadzenDataGridColumn Property="CreatedAt" Title="Creada el" FormatString="{0:dd/MM/yyyy HH:mm}" MinWidth="120px" Width="160px" />

    </Columns>
</RadzenDataGrid>

@code {

    [Parameter] public int ConsignorId { get; set; }

    private RadzenDataGrid<ConsignmentDto> grid = null!;
    private IEnumerable<ConsignmentDto>? consignments;

    private int count;
    private bool isLoading = false;
    private string GridMessage = "No hay consignaciones para mostrar.";

    private LogicalFilterOperator logicalFilterOperator = RadzenDataGridDefaults.FilterOperator;

 
    async Task LoadConsignments(LoadDataArgs args)
    {
        if (isLoading) return;

        isLoading = true;

        QueryRequest request = RadzenQueryRequestMapper.ConvertToQueryRequest(args, logicalFilterOperator);

        var result = await ConsignmentService.GetByConsignorIdAsync(request, ConsignorId, CancellationToken.None);
        if (result.IsSuccess)
        {
            consignments = result.Value.Items;
            count = result.Value.Count;
        }
        else
        {
            consignments = [];
            count = 0;
            GridMessage = result.Error.Description;
            DialogService.Close();
        }

        isLoading = false;
    }

    private void ViewConsignment(int consignmentId)
    {
        NavigationManager.NavigateTo($"/consignaciones/{consignmentId}");
    }

}
