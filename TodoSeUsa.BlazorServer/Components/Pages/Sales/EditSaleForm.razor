@using TodoSeUsa.Application.Features.Sales.DTOs
@using TodoSeUsa.Application.Features.Sales.Interfaces

@inject ISaleService _saleService;

@inject DialogService _dialogService;

<RadzenTemplateForm TItem="EditSaleDto" Data=@_editableSaleDto Submit=@OnSubmit>

    <RadzenStack Gap="1rem">

        <RadzenFieldset Text="Info. de la venta">

            <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">

                <RadzenRow id="notes-row">
                    <RadzenColumn Size="6" id="notes-column">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                            <RadzenLabel Component="Notes">
                                Notas <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenTextArea Rows="5" Cols="30" Name="Notes" @bind-Value=@_editableSaleDto.Notes Style="width: 100%;" Change="@OnNotesChanged" Placeholder="Notas..." />

                            <RadzenCustomValidator Component="Notes"
                                                   Validator="@(() => IsEmptyOrMatchesAlphanumericPattern(_editableSaleDto.Notes))"
                                                   Text="Las notas deben tener entre 1 y 250 caracteres válidos (no solo espacios o símbolos)." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenStack AlignItems="AlignItems.End" JustifyContent="JustifyContent.End" class="rz-mt-4">

                    <RadzenButton Icon="reset_settings" Click="@ResetEditToOriginal" Text="Resetear" />

                </RadzenStack>

            </RadzenStack>
        </RadzenFieldset>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" class="rz-mt-8">

            <RadzenButton IsBusy=@_isSaveButtonBusy BusyText="Guardando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Guardar" Disabled=!HasChanges() />

            <RadzenButton Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Base" Icon="cancel" Text="Cancelar" Click="@(() => _dialogService.Close())" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code
{
    [Parameter] public required EditSaleDto SaleDto { get; set; }

    private bool _isSaveButtonBusy;

    private EditSaleDto _editableSaleDto = new();

    protected override void OnInitialized()
    {
        _editableSaleDto = new()
        {
            Id = SaleDto.Id,
            Notes = SaleDto.Notes
        };
    }

    async Task OnSubmit(EditSaleDto _editableSaleDto)
    {
        _isSaveButtonBusy = true;
        var result = await _saleService.EditAsync(_editableSaleDto, CancellationToken.None);
        _isSaveButtonBusy = false;
        _dialogService.Close(result);
    }

    private void OnNotesChanged(string? value)
    {
        _editableSaleDto.Notes = value == "" ? null : value;
        StateHasChanged();
    }

    bool IsEmptyOrMatchesAlphanumericPattern(string? input)
    {
        if (string.IsNullOrEmpty(input))
            return true;

        return Regex.IsMatch(input, "^(?=.*[A-Za-z0-9]).{1,250}$");
    }

    private void ResetEditToOriginal()
    {
        _editableSaleDto.Notes = SaleDto.Notes;

        StateHasChanged();
    }

    private bool HasChanges()
    {
        return !string.Equals(_editableSaleDto.Notes, SaleDto.Notes, StringComparison.OrdinalIgnoreCase);
    }
}

