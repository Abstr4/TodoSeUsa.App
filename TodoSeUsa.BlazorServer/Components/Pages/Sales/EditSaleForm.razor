@using TodoSeUsa.Application.Features.Sales.DTOs
@using TodoSeUsa.Application.Features.Sales.Interfaces

@inject ISaleService SaleService;

@inject DialogService DialogService;
@inject SimpleNotifications SimpleNotifications;


<RadzenTemplateForm TItem="EditSaleDto" Data=@editSaleDto Submit=@OnSubmit>

    <RadzenStack Gap="1rem">

        <RadzenFieldset Text="Info. de la venta">

            <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">

                <RadzenRow id="notes-row">
                    <RadzenColumn Size="6" id="notes-column">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                            <RadzenLabel Component="Notes">
                                Notas <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenTextArea Rows="5" Cols="30" Name="Notes" @bind-Value=@editSaleDto.Notes Style="width: 100%;" Change="@OnNotesChanged" Placeholder="Notas..." />

                            <RadzenCustomValidator Component="Notes"
                                                   Validator="@(() => IsEmptyOrMatchesAlphanumericPattern(editSaleDto.Notes))"
                                                   Text="Las notas deben tener entre 1 y 250 caracteres válidos (no solo espacios o símbolos)." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow id="dateIssued-row">
                    <RadzenColumn Size="6" id="dateIssued-column">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                            <RadzenLabel Component="DateIssued">
                                Fecha de emisión <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>

                            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                <RadzenDatePicker Name="DateIssued" @bind-Value=@editSaleDto.DateIssued Max="DateTime.Now" Style="flex-grow: 1;" Change="@OnDateIssuedChanged" Placeholder="Fecha de emisión..." />

                                <RadzenButton Icon="alarm" Click="@(() => editSaleDto.DateIssued = DateTime.Now)" Text="Ahora" />
                            </RadzenStack>

                            <RadzenRequiredValidator Component="DateIssued" Text="La fecha de emisión es requerida." />
                        </RadzenStack>
                    </RadzenColumn>

                </RadzenRow>

                <RadzenStack AlignItems="AlignItems.End" JustifyContent="JustifyContent.End" class="rz-mt-4">

                    <RadzenButton Icon="reset_settings" Click="@ResetEditToOriginal" Text="Resetear" />

                </RadzenStack>

            </RadzenStack>
        </RadzenFieldset>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" class="rz-mt-8">

            <RadzenButton IsBusy=@busy BusyText="Guardando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Guardar" Disabled=!HasChanges() />

            <RadzenButton Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Base" Icon="cancel" Text="Cancelar" Click="@(() => DialogService.Close())" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code
{
    [Parameter] public required SaleDto SaleDto { get; set; }

    private bool busy;

    private EditSaleDto editSaleDto = new();

    protected override void OnInitialized()
    {
        SetEditDtoToOriginal();
    }

    private void SetEditDtoToOriginal()
    {
        editSaleDto = new EditSaleDto
        {
            Notes = SaleDto.Notes,
            DateIssued = SaleDto.DateIssued
        };
    }

    async Task OnSubmit(EditSaleDto editSaleDto)
    {
        busy = true;
        var result = await SaleService.EditByIdAsync(SaleDto.Id, editSaleDto, CancellationToken.None);
        busy = false;
        DialogService.Close(result);
    }

    private void OnNotesChanged(string? value)
    {
        editSaleDto.Notes = value == "" ? null : value;
        StateHasChanged();
    }

    bool IsEmptyOrMatchesAlphanumericPattern(string? input)
    {
        if (string.IsNullOrEmpty(input))
            return true;

        return Regex.IsMatch(input, "^(?=.*[A-Za-z0-9]).{1,250}$");
    }

    private void OnDateIssuedChanged(DateTime? value)
    {
        if (value != null)
        {
            editSaleDto.DateIssued = value.Value;
            StateHasChanged();
        }
        else
        {
            editSaleDto.DateIssued = DateTime.Now;
        }
    }

    private void ResetEditToOriginal()
    {
        SetEditDtoToOriginal();
        StateHasChanged();
    }

    private bool HasChanges()
    {
        return !string.Equals(editSaleDto.Notes, SaleDto.Notes, StringComparison.OrdinalIgnoreCase) ||
               editSaleDto.DateIssued != SaleDto.DateIssued ||
               !string.Equals(editSaleDto.Notes, SaleDto.Notes, StringComparison.OrdinalIgnoreCase);
    }
}

