@using TodoSeUsa.Application.Features.Sales.DTOs
@using TodoSeUsa.Application.Features.Sales.Interfaces

@inject ISaleService SaleService;

@inject DialogService DialogService;


<RadzenTemplateForm TItem="CreateSaleDto" Data=@createSaleDto Submit=@OnSubmit>
    <RadzenStack Gap="1rem">
        <RadzenFieldset Text="Detalles de la venta">
            <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
                <RadzenRow>
                    <RadzenColumn Size="6" id="notes-column">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                            <RadzenLabel Component="Notes">
                                Notas <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenTextArea Rows="5" Cols="30" Name="Notes" @bind-Value=@createSaleDto.Notes Style="width: 100%;" Change="@OnNotesChanged" Placeholder="Notas..." />

                            <RadzenCustomValidator Component="Notes"
                                                  Validator="(() => InputValidators.IsNullOrEmptyOrMatchesAlphanumericPattern(createSaleDto.Notes))"
                                                  Text="Las notas no pueden ser solo espacios o símbolos." />
                            <RadzenLengthValidator Min="1" Max="250" Text="Las notas deben tener entre 1 y 250 carácteres." />
                        </RadzenStack>
                    </RadzenColumn>

                </RadzenRow>
                <RadzenRow>
                    <RadzenColumn Size="6" id="dateIssued-column">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                            <RadzenLabel Component="DateIssued">
                                Fecha de emisión <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>

                            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                <RadzenDatePicker Max="DateTime.Now" Name="DateIssued" @bind-Value=@createSaleDto.DateIssued Style="flex-grow: 1;" Placeholder="Fecha de emisión..." />

                                <RadzenButton Icon="alarm" Click="@(() => createSaleDto.DateIssued = DateTime.Now)" Text="Ahora" />
                            </RadzenStack>

                            <RadzenRequiredValidator Component="DateIssued" Text="La fecha de emisión es requerida." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenFieldset>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="1rem" class="rz-mt-8">
            <RadzenButton IsBusy="@busy" BusyText="Guardando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Guardar" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code
{
    [Parameter] public int? ProviderId { get; set; }

    private bool busy;

    private CreateSaleDto createSaleDto = new();

    async Task OnSubmit(CreateSaleDto createSaleDto)
    {
        busy = true;
        var result = await SaleService.CreateAsync(createSaleDto, CancellationToken.None);
        busy = false;
        DialogService.Close(result);
    }

    private void OnNotesChanged(string? value)
    {
        createSaleDto.Notes = value == "" ? null : value;
        StateHasChanged();
    }
}

