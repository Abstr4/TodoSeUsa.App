@page "/test"

@using TodoSeUsa.Application.Common.Models
@using TodoSeUsa.Application.Features.Boxes.DTOs
@using TodoSeUsa.Application.Features.Boxes.Interfaces
@using TodoSeUsa.BlazorServer.Helpers

@inject IBoxService boxService;
@inject DialogService DialogService;
@inject NavigationManager Navigation;

<PageLayoutSection Title="Cajas">
    <RadzenCard Style="max-width: 100%">
        <RadzenStack Gap="1rem">
            <RadzenCard Variant="Variant.Outlined">
                <FilterControls LogicalFilterValue="@logicalFilterOperator" LogicalFilterValueChanged="@(v => logicalFilterOperator = v)" LogicalFilterOnChanged="@(async () => await grid.Reload())" ResetButtonClicked="@ResetAsync" />
            </RadzenCard>
            <RadzenDataGrid @ref="grid"
                            ColumnWidth="200px"
                            style="height: 400px"
                            IsLoading="@isLoading"
                            TItem="BoxDto"
                            Data="@boxes"
                            Count="@count"
                            LoadData="@LoadData"
                            AllowSorting="true"
                            AllowFiltering="true"
                            AllowPaging="true"
                            FilterMode="FilterMode.Simple"
                            FilterCaseSensitivity="@filterCaseSensitivity"
                            LogicalFilterOperator="@logicalFilterOperator"
                            GridLines="DataGridGridLines.Both"
                            PageSize="5"
                            PagerHorizontalAlign="HorizontalAlign.Center"
                            EmptyText="@GridMessage"
                            ClearFilterText="Limpiar"
                            ApplyFilterText="Aplicar"
                            FilterText="Filtro"
                            ContainsText="Contiene"
                            EqualsText="Equivale"
                            AndOperatorText="Y"
                            OrOperatorText="O"
                            LessThanOrEqualsText="Menor o igual que"
                            LessThanText="Menor que"
                            GreaterThanOrEqualsText="Mayor o igual que"
                            GreaterThanText="Mayor que"
                            NotEqualsText="No es igual a">
                <Columns>
                    <RadzenDataGridColumn TItem="BoxDto" Title="" Filterable="false" Sortable="false" Resizable="false" Width="80px" MinWidth="80px">
                        <Template Context="item">
                            <GridSplitActionsColumn TItem="BoxDto" Item="item" OnActionClick="OnActionClick" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Frozen="true" Property="@nameof(BoxDto.Id)" Title="ID" Width="80px" TextAlign="TextAlign.Center" />

                    <RadzenDataGridColumn Filterable="false" Property="@nameof(BoxDto.BoxCode)" Title="Código" Width="80px" />

                    <RadzenDataGridColumn Filterable="false" Property="@nameof(BoxDto.TotalProducts)" Title="Cant. productos" Width="120px" />

                    <RadzenDataGridColumn Property="@nameof(BoxDto.Location)" Title="Ubicación" Width="160px" />

                    <RadzenDataGridColumn Property="@nameof(BoxDto.CreatedAt)" Title="Creada el" Width="160px" />

                    <RadzenDataGridColumn Frozen="true" TItem="BoxDto" Title="Acciones" Filterable="false" Sortable="false" Width="300px" MinWidth="300px">
                        <Template Context="item">
                            <GridRowActionsColumn TItem="BoxDto" Item="item" OnViewClick="@(box => ViewBox(box))" OnEditClick="@(box => EditBox(box))" OnDeleteClick="@(box => DeleteBox(box))" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenStack>
    </RadzenCard>
</PageLayoutSection>

@code {
    private RadzenDataGrid<BoxDto> grid = null!;
    private IEnumerable<BoxDto> boxes = null!;
    private int count;
    private bool isLoading = false;
    private string GridMessage = "No hay cajas para mostrar.";
    private CancellationTokenSource? cts;

    private LogicalFilterOperator logicalFilterOperator = LogicalFilterOperator.And;
    private FilterCaseSensitivity filterCaseSensitivity = FilterCaseSensitivity.CaseInsensitive;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await grid.Reload();
        }
    }

    async Task LoadData(LoadDataArgs args)
    {
        if (isLoading) return;

        isLoading = true;

        cts?.Cancel();
        cts = new CancellationTokenSource();
        try
        {
            QueryItem query = new(args.Filter, args.OrderBy, args.Skip ?? 0, args.Top ?? 5);

            var result = await boxService.GetBoxesWithPaginationAsync(query, cts.Token);
            if (result.IsSuccess)
            {
                boxes = result.Value.Items;
                count = result.Value.Count;
            }
            else
            {
                boxes = [];
                count = 0;
                GridMessage = result.Error.Description;
            }
        }
        catch (OperationCanceledException)
        {

        }
        finally
        {
            isLoading = false;
        }
    }

    void ViewBox(BoxDto box)
    {
        // Example 1: navigate to a details page
        Navigation.NavigateTo($"/cajas/{box.Id}");

        // Example 2 (optional): open a dialog instead
        // await DialogService.OpenAsync<YourBoxDetailsComponent>("Detalles de Caja", new Dictionary<string, object> { ["Box"] = box });
    }

    void EditBox(BoxDto box)
    {
        Navigation.NavigateTo($"/cajas/editar/{box.Id}");
    }

    async Task DeleteBox(BoxDto box)
    {
        var confirmed = await DialogService.Confirm(
            $"¿Eliminar la caja {box.BoxCode}?",
            "Confirmar eliminación",
            new ConfirmOptions { OkButtonText = "Sí", CancelButtonText = "No" });

        if (confirmed == true)
        {
            Console.WriteLine($"Deleting box {box.Id}");

            await grid.Reload();
        }
    }

    private void OnActionClick((RadzenSplitButtonItem button, BoxDto item) args)
    {
        if (args.button != null && !string.IsNullOrWhiteSpace(args.button.Value))
        {
            switch (args.button.Value.ToString())
            {
                case "view":
                    ViewBox(args.item);
                    break;
                case "edit":
                    EditBox(args.item);
                    break;
                case "delete":
                    _ = DeleteBox(args.item);
                    break;
                default:
                    ViewBox(args.item);
                    break;
            }
        }
        else
        {
            ViewBox(args.item);
        }
    }

    async Task ResetAsync()
    {
        cts?.Cancel();

        grid.Reset(true);
        await grid.FirstPage(true);
    }
}
