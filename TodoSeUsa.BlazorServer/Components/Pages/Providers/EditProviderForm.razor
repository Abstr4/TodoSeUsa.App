@using TodoSeUsa.Application.Features.Providers.DTOs
@using TodoSeUsa.Application.Features.Providers.Interfaces
@using TodoSeUsa.BlazorServer.UI.Notifications
@using TodoSeUsa.BlazorServer.Validation

@inject IProviderService ProviderService;

@inject DialogService DialogService;
@inject SimpleNotifications SimpleNotifications;
@inject TooltipService TooltipService;

@attribute [Authorize]

<RadzenTemplateForm TItem="EditProviderDto" Data=@editProviderDto Submit=@OnSubmit>

    <RadzenStack Gap="1rem">
        
        <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">

            <RadzenFieldset Text="Información básica">

                <RadzenRow Gap="1rem">

                    <RadzenColumn Size="6" id="firstName-column">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                            <RadzenLabel Component="FirstName">
                                Nombre <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>

                            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">
                                <RadzenTextBox MaxLength="50" Name="FirstName" @bind-Value=@editProviderDto.FirstName Style="width: 100%;" Placeholder="Nombre..." />
                            </RadzenStack>

                            <RadzenRequiredValidator Component="FirstName" Text="El nombre es requerido." />
                            <RadzenLengthValidator Component="FirstName" Text="El nombre debe tener menos de 50 carácteres." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="6" id="lastName-column">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                            <RadzenLabel Component="LastName">
                                Apellido <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>

                            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">
                                <RadzenTextBox MaxLength="100" Name="LastName" @bind-Value=@editProviderDto.LastName Style="width: 100%;" Placeholder="Apellido..." />
                            </RadzenStack>

                            <RadzenRequiredValidator Component="LastName" Text="El apellido es requerido." />
                            <RadzenLengthValidator Component="LastName" Text="El apellido debe tener menos de 100 carácteres." />

                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="6" id="comissionPercent-column">

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                            <RadzenLabel Component="CommissionPercent">
                                Porcentaje de comisión <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>

                            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">
                                <RadzenNumeric Min="0" Max="100" Name="CommissionPercent" @bind-Value=@editProviderDto.CommissionPercent Style="width: 100%;" Placeholder="Porcentaje de comisión..." />
                            </RadzenStack>

                            <RadzenRequiredValidator Component="CommissionPercent" Text="El porcentaje de comisión es requerido." />
                            <RadzenNumericRangeValidator Component="CommissionPercent" Min="0" Max="100" Text="El porcentaje de comisión debe estar entre 0 y 100." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenFieldset>

            <RadzenFieldset Text="Información de contacto">

                <HeaderTemplate>
                    <RadzenIcon Style="margin-left: 4px" class="filled-icon" Icon="info" IconColor="@Colors.Warning" MouseEnter="@(args => ShowTooltip(args))" />
                </HeaderTemplate>

                <ChildContent>

                    <RadzenRow Gap="1rem">

                        <RadzenColumn Size="6" id="emailAddress-column">

                            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                <RadzenLabel Component="EmailAddress">
                                    Email <RadzenIcon class="filled-icon" Icon="info" IconColor="@Colors.Warning" MouseEnter="@(args => ShowTooltip(args))" />
                                </RadzenLabel>

                                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                    <RadzenTextBox Name="EmailAddress" MaxLength="250" @bind-Value=@editProviderDto.EmailAddress Style="width: 100%;" Change="@OnEmailAddressChanged" Placeholder="Email..." />

                                    <RadzenCustomValidator Component="EmailAddress" Validator="@(() => InputValidators.IsValidEmailAddress(editProviderDto.EmailAddress))" Text="El email es inválido. Ejemplo: 'ejemplo@dominio.com'." />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="6" id="phoneNumber-column">

                            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                <RadzenLabel Component="PhoneNumber">
                                    Número de teléfono <RadzenIcon class="filled-icon" Icon="info" IconColor="@Colors.Warning" MouseEnter="@(args => ShowTooltip(args))" />
                                </RadzenLabel>

                                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">
                                    <RadzenTextBox MaxLength=20 Name="PhoneNumber" @bind-Value=@editProviderDto.PhoneNumber Style="width: 100%;" Change="@OnPhoneNumberChanged" Placeholder="Número de teléfono..." />
                                    <RadzenCustomValidator Component="PhoneNumber" Validator="@(() => InputValidators.IsValidPhoneNumber(editProviderDto.PhoneNumber))" Text="El número de teléfono es inválido. Ingrese uno como '1234 567 890'." />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" id="ghost-contactInfo-validation">

                            <RadzenTextBox Name="ContactGhost"
                                           Style="display:none"
                                           @bind-Value="contactGhost" />

                            <RadzenCustomValidator Component="ContactGhost" Text="Debes ingresar al menos un dato de contacto (Email o Número de teléfono)." Validator="@(() => InputValidators.IsValidContactInformation(editProviderDto.EmailAddress, editProviderDto.PhoneNumber))" />
                        </RadzenColumn>
                        <RadzenColumn Size="6" id="address-column">

                            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                <RadzenLabel Component="Address">
                                    Dirección <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                </RadzenLabel>

                                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                    <RadzenTextBox Name="Address" @bind-Value=@editProviderDto.Address Style="width: 100%;" Change="@OnAddressChanged" Placeholder="Dirección..." />

                                    <RadzenCustomValidator Component="Address" Validator="@(() => InputValidators.IsNullOrEmptyOrMatchesAlphanumericPattern(editProviderDto.Address))" 
                                        Text="Debe ingresar un texto válido, no sólo símbolos o espacios en blanco." />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenStack AlignItems="AlignItems.End" JustifyContent="JustifyContent.End" class="rz-mt-4">
                        <RadzenButton Icon="reset_settings" Click="@ResetEditToOriginal" Text="Resetear" />
                    </RadzenStack>
                </ChildContent>
            </RadzenFieldset>
        </RadzenStack>


        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" class="rz-mt-8">

            <RadzenButton IsBusy=@busy BusyText="Editando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Editar" Disabled=@(!HasChanges()) />

            <RadzenButton Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Base" Icon="cancel" Text="Cancelar" Click="@(() => DialogService.Close())" />
        </RadzenStack>

    </RadzenStack>
</RadzenTemplateForm>

@code
{
    private bool busy;

    [Parameter] public required ProviderDto ProviderDto { get; set; }

    private EditProviderDto editProviderDto = new();

    private string contactGhost = "";

    protected override void OnInitialized()
    {
        SetEditDtoToOriginal();
    }

    async Task OnSubmit(EditProviderDto editProviderDto)
    {
        busy = true;
        var result = await ProviderService.EditByIdAsync(ProviderDto.Id, editProviderDto, CancellationToken.None);
        busy = false;
        DialogService.Close(result);
    }

    private void OnEmailAddressChanged(string? value)
    {
        editProviderDto.EmailAddress = value == "" ? null : value;
        StateHasChanged();
    }

    private void OnAddressChanged(string? value)
    {
        editProviderDto.Address = value == "" ? null : value;
        StateHasChanged();
    }

    private void OnPhoneNumberChanged(string? value)
    {
        editProviderDto.PhoneNumber = value == "" ? null : value;
        StateHasChanged();
    }

    private void ResetEditToOriginal()
    {
        SetEditDtoToOriginal();
        StateHasChanged();
    }

    private void SetEditDtoToOriginal()
    {
        editProviderDto = new EditProviderDto
        {
            FirstName = ProviderDto.FirstName,
            LastName = ProviderDto.LastName,
            EmailAddress = ProviderDto.EmailAddress,
            PhoneNumber = ProviderDto.PhoneNumber,
            Address = ProviderDto.Address,
            CommissionPercent = ProviderDto.CommissionPercent
        };
    }

    private bool HasChanges()
    {
        return 
            editProviderDto.FirstName != ProviderDto.FirstName ||
            editProviderDto.LastName != ProviderDto.LastName ||
            editProviderDto.EmailAddress != ProviderDto.EmailAddress ||
            editProviderDto.PhoneNumber != ProviderDto.PhoneNumber ||
            editProviderDto.Address != ProviderDto.Address ||
            editProviderDto.CommissionPercent != ProviderDto.CommissionPercent;
    }

    void ShowTooltip(ElementReference elementReference)
    {
        TooltipService.Open(elementReference, "Se necesita un método de contacto (Email o número de tel.)");
    }
}

