@using System.Text.Json
@using System.Text.RegularExpressions
@using TodoSeUsa.Application.Features.Providers.DTOs
@using TodoSeUsa.Application.Features.Providers.Interfaces
@using TodoSeUsa.BlazorServer.Helpers
@using TodoSeUsa.Domain.Enums

@inject DialogService DialogService;
@inject IProviderService ProviderService;
@inject SimpleNotifications SimpleNotifications;


<RadzenTemplateForm TItem="EditProviderDto" Data=@editProviderDto Submit=@OnSubmit>
    <RadzenStack Gap="1rem">
        <RadzenFieldset Text="Info. del proveedor">
            <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
                <RadzenRow>
                    <RadzenColumn Size="6" id="firstName-column">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                            <RadzenLabel Component="FirstName">
                                Nombre <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                            </RadzenLabel>
                            <RadzenTextBox Name="FirstName" @bind-Value=@editProviderDto.FirstName Style="width: 100%;" Change="@OnFirstNameChanged" Placeholder="Nombre..." />

                            <RadzenRegexValidator Component="FirstName"
                                                  Pattern="^(?=.*[A-Za-z0-9]).{1,250}$"
                                                  Text="- El nombre deben tener entre 1 y 250 caracteres válidos (no solo espacios o símbolos)." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow>
                    <RadzenColumn Size="12" SizeSM="12" id="refresh-button">

                        <RadzenStack Style="height: 100%" Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" JustifyContent="JustifyContent.End">

                            <RadzenButton Click="@ResetToOriginal">

                                <RadzenIcon Icon="reset_settings"></RadzenIcon>

                            </RadzenButton>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenFieldset>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" class="rz-mt-8">

            <RadzenButton IsBusy=@busy BusyText="Guardando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Guardar" Disabled=@IsSaveDisabled />

            <RadzenButton Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Base" Icon="cancel" Text="Cancelar" Click="@(() => DialogService.Close())" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code
{
    [Parameter] public required ProviderDto ProviderDto { get; set; }

    private bool busy;

    private bool IsSaveDisabled => !(IsCommissionPercentValid && IsFirstNameValid && IsLastNameValid);

    private bool IsCommissionPercentValid => editProviderDto.CommissionPercent >= 0m && editProviderDto.CommissionPercent <= 100m;
    private bool IsFirstNameValid => editProviderDto.FirstName.Length > 0 || editProviderDto.FirstName.Length < 50;
    private bool IsLastNameValid => editProviderDto.LastName.Length > 0 || editProviderDto.LastName.Length < 100;
    private bool IsEmailValid => EmailValidator(editProviderDto.EmailAddress);
    private bool IsPhoneNumberValid => IsValidE164Phone(editProviderDto.PhoneNumber);
    private bool IsAddressValid => IsEmptyOrMatchesAlphanumericPattern(editProviderDto.Address);

    private EditProviderDto editProviderDto = new();

    protected override void OnInitialized()
    {
        SetEditDtoToOriginal();
    }

    private void SetEditDtoToOriginal()
    {
        editProviderDto = new EditProviderDto
        {
            FirstName = ProviderDto.FirstName

        };
    }

    async Task OnSubmit(EditProviderDto editProviderDto)
    {
        busy = true;
        var result = await ProviderService.EditByIdAsync(ProviderDto.Id, editProviderDto, CancellationToken.None);
        busy = false;
        DialogService.Close(result);
    }

    private void OnFirstNameChanged(string value)
    {
        editProviderDto.FirstName = value;
        StateHasChanged();
    }


    private void ResetToOriginal()
    {
        SetEditDtoToOriginal();
        StateHasChanged();
    }

    private void OnEmailAddressChanged(string? value)
    {
        editProviderDto.EmailAddress = value == "" ? null : value;
        StateHasChanged();
    }

    bool IsEmptyOrMatchesAlphanumericPattern(string? input)
    {
        if (string.IsNullOrEmpty(input))
            return true;

        return Regex.IsMatch(input, "^(?=.*[A-Za-z0-9]).{1,250}$");
    }

    private bool EmailValidator(string? email)
    {
        if (email is null) return true;

        int index = email.IndexOf('@');

        return
            email.Length >= 3 &&
            email.Length <= 250 &&
            index > 0 &&
            index != email.Length - 1 &&
            index == email.LastIndexOf('@');
    }

    private bool IsValidE164Phone(string? phone)
    {
        if (string.IsNullOrWhiteSpace(phone)) return true;

        return Regex.IsMatch(phone, @"^\+[1-9]\d{1,14}$");
    }

    private bool HasChanges()
    {
        return editProviderDto.FirstName != ProviderDto.FirstName;

    }
}

