@using TodoSeUsa.Application.Features.Providers.DTOs
@using TodoSeUsa.Application.Features.Providers.Interfaces
@using TodoSeUsa.BlazorServer.Validation

@rendermode InteractiveServer

@inject IProviderService ProviderService;

@inject DialogService DialogService;
@inject TooltipService TooltipService;

@attribute [Authorize]

<style>
    .filled-icon {
        font-variation-settings: 'FILL';
    }
</style>


<RadzenTemplateForm TItem="CreateProviderDto" Data=@createProviderDto Submit=@OnSubmit>

    <RadzenStack Gap="1rem">
        
        <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">

            <RadzenFieldset Text="Información básica">

                    <RadzenRow Gap="1rem">

                        <RadzenColumn Size="6" id="firstName-column">

                            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                <RadzenLabel Component="FirstName">
                                    Nombre <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                </RadzenLabel>

                                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">
                                    <RadzenTextBox MaxLength="50" Name="FirstName" @bind-Value=@createProviderDto.FirstName Style="width: 100%;" Placeholder="Nombre..." />
                                </RadzenStack>

                                <RadzenRequiredValidator Component="FirstName" Text="El nombre es requerido." />
                                <RadzenLengthValidator Component="FirstName" Text="El nombre debe tener menos de 50 carácteres" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="6" id="lastName-column">

                            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                <RadzenLabel Component="LastName">
                                    Apellido <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                </RadzenLabel>

                                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">
                                    <RadzenTextBox MaxLength="100" Name="LastName" @bind-Value=@createProviderDto.LastName Style="width: 100%;" Placeholder="Apellido..." />
                                </RadzenStack>

                                <RadzenRequiredValidator Component="LastName" Text="El apellido es requerido." />
                                <RadzenLengthValidator Component="LastName" Text="El apellido debe tener menos de 100 carácteres" />

                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="6" id="comissionPercent-column">

                            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                <RadzenLabel Component="CommissionPercent">
                                    Porcentaje de comisión <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Requerido" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                </RadzenLabel>

                                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">
                                    <RadzenNumeric Min="0" Max="100" Name="CommissionPercent" @bind-Value=@createProviderDto.CommissionPercent Style="width: 100%;" Placeholder="Porcentaje de comisión..." />
                                </RadzenStack>

                                <RadzenRequiredValidator Component="CommissionPercent" Text="El porcentaje de comisión es requerido." />
                                <RadzenNumericRangeValidator Component="CommissionPercent" Min="0" Max="100" Text="El porcentaje de comisión debe estar entre 0 y 100." />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenFieldset>

            <RadzenFieldset Text="Información de contacto">
                <HeaderTemplate>
                    <RadzenIcon Style="margin-left: 4px" class="filled-icon" Icon="info" IconColor="@Colors.Warning" MouseEnter="@(args => ShowTooltip(args))" />
                </HeaderTemplate>
                <ChildContent>
                    <RadzenRow Gap="1rem">

                        <RadzenColumn Size="6" id="emailAddress-column">

                            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                <RadzenLabel Component="EmailAddress">
                                        Email <RadzenIcon class="filled-icon" Icon="info" IconColor="@Colors.Warning" MouseEnter="@(args => ShowTooltip(args))" />
                                </RadzenLabel>

                                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                    <RadzenTextBox Name="EmailAddress" MaxLength="250" @bind-Value=@createProviderDto.EmailAddress Style="width: 100%;" Change="@OnEmailAddressChanged" Placeholder="Email..." />

                                    <RadzenCustomValidator Component="EmailAddress" Validator="@(() => InputValidators.IsValidEmailAddress(createProviderDto.EmailAddress))" Text="El email es inválido. Ingrese un válido como: 'ejemplo@dominio.com'." />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="6" id="phoneNumber-column">

                            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                <RadzenLabel Component="PhoneNumber">
                                        Número de teléfono <RadzenIcon class="filled-icon" Icon="info" IconColor="@Colors.Warning" MouseEnter="@(args => ShowTooltip(args))" />
                                </RadzenLabel>

                                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">
                                    <RadzenTextBox MaxLength=20 Name="PhoneNumber" @bind-Value=@createProviderDto.PhoneNumber Style="width: 100%;" Change="@OnPhoneNumberChanged" Placeholder="Número de teléfono..." />
                                        <RadzenCustomValidator Component="PhoneNumber" Validator="@(() => InputValidators.IsValidPhoneNumber(createProviderDto.PhoneNumber))" Text="El número de teléfono es inválido. Ingrese uno como '1234 567 890'." />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" id="ghost-contactInfo-validation">

                            <RadzenTextBox Name="ContactGhost"
                                           Style="display:none"
                                           @bind-Value="contactGhost" />

                            <RadzenCustomValidator Component="ContactGhost" Text="Debes ingresar al menos un dato de contacto (Email o Número de teléfono)." Validator="@(() => InputValidators.IsValidContactInformation(createProviderDto.EmailAddress, createProviderDto.PhoneNumber))" />
                        </RadzenColumn>
                        <RadzenColumn Size="6" id="address-column">

                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">

                                    <RadzenLabel Component="Address">
                                        Dirección <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Opcional" Variant="Variant.Outlined" IsPill="true" class="rz-ml-1" />
                                    </RadzenLabel>

                                    <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                        <RadzenTextBox Name="Address" @bind-Value=@createProviderDto.Address Style="width: 100%;" Change="@OnAddressChanged" Placeholder="Dirección..." />

                                        <RadzenCustomValidator Component="Address" Validator="@(() => InputValidators.IsNullOrEmptyOrMatchesAlphanumericPattern(createProviderDto.Address))"
                                            Text="Debe ingresar un texto válido, no sólo simbolos y espacios en blanco." />
                                    </RadzenStack>
                                </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>
                </ChildContent>
            </RadzenFieldset>
        </RadzenStack>
        
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="1rem" class="rz-mt-8">

            <RadzenButton IsBusy="@busy" BusyText="Creando..." ButtonType="ButtonType.Submit" Size="ButtonSize.Medium" Icon="save" Text="Crear" />

        </RadzenStack>

    </RadzenStack>
</RadzenTemplateForm>

@code
{
    private bool busy;

    private string contactGhost = "";

    private CreateProviderDto createProviderDto = new();

    protected override void OnInitialized()
    {
        createProviderDto.CommissionPercent = 0m;
    }

    async Task OnSubmit()
    {
        busy = true;
        var result = await ProviderService.CreateAsync(createProviderDto, CancellationToken.None);
        busy = false;
        DialogService.Close(result);
    }

    private void OnEmailAddressChanged(string? value)
    {
        createProviderDto.EmailAddress = value == "" ? null : value;
        StateHasChanged();
    }

    private void OnAddressChanged(string? value)
    {
        createProviderDto.Address = value == "" ? null : value;
        StateHasChanged();
    }

    private void OnPhoneNumberChanged(string? value)
    {
        createProviderDto.PhoneNumber = value == "" ? null : value;
        StateHasChanged();
    }

    void ShowTooltip(ElementReference elementReference)
    {
        TooltipService.Open(elementReference, "Se necesita un método de contacto (Email o Número de tel.)");
    }
}

